{"task": "SQL-based_authentication", "blocks": [{"lang": "C", "loc": 174, "block": "<pre class=\"c highlighted_source\"><span class=\"co2\">#include &lt;stdio.h&gt;</span><br/><span class=\"co2\">#include &lt;stdlib.h&gt;</span><br/><span class=\"co2\">#include &lt;string.h&gt;</span><br/><span class=\"co2\">#include &lt;stdbool.h&gt;</span><br/><span class=\"co2\">#include &lt;time.h&gt;</span><br/>\u00a0<br/><span class=\"co2\">#include &lt;mysql.h&gt;</span><br/><span class=\"co2\">#include &lt;openssl/md5.h&gt;</span><br/>\u00a0<br/><span class=\"kw4\">void</span> end_with_db<span class=\"br0\">(</span><span class=\"kw4\">void</span><span class=\"br0\">)</span><span class=\"sy0\">;</span><br/>\u00a0<br/>MYSQL <span class=\"sy0\">*</span>mysql <span class=\"sy0\">=</span> NULL<span class=\"sy0\">;</span> <span class=\"co1\">// global...</span><br/>\u00a0<br/>bool connect_db<span class=\"br0\">(</span><span class=\"kw4\">const</span> <span class=\"kw4\">char</span> <span class=\"sy0\">*</span>host<span class=\"sy0\">,</span> <span class=\"kw4\">const</span> <span class=\"kw4\">char</span> <span class=\"sy0\">*</span>user<span class=\"sy0\">,</span> <span class=\"kw4\">const</span> <span class=\"kw4\">char</span> <span class=\"sy0\">*</span>pwd<span class=\"sy0\">,</span><br/>\t\t<span class=\"kw4\">const</span> <span class=\"kw4\">char</span> <span class=\"sy0\">*</span>db<span class=\"sy0\">,</span> <span class=\"kw4\">unsigned</span> <span class=\"kw4\">int</span> port<span class=\"br0\">)</span><br/><span class=\"br0\">{</span><br/>  <span class=\"kw1\">if</span> <span class=\"br0\">(</span> mysql <span class=\"sy0\">==</span> NULL <span class=\"br0\">)</span><br/>  <span class=\"br0\">{</span><br/>    <span class=\"kw1\">if</span> <span class=\"br0\">(</span>mysql_library_init<span class=\"br0\">(</span><span class=\"nu0\">0</span><span class=\"sy0\">,</span> NULL<span class=\"sy0\">,</span> NULL<span class=\"br0\">)</span><span class=\"br0\">)</span> <span class=\"kw1\">return</span> <span class=\"kw2\">false</span><span class=\"sy0\">;</span><br/>    mysql <span class=\"sy0\">=</span> mysql_init<span class=\"br0\">(</span>NULL<span class=\"br0\">)</span><span class=\"sy0\">;</span> <span class=\"kw1\">if</span> <span class=\"br0\">(</span> mysql <span class=\"sy0\">==</span> NULL <span class=\"br0\">)</span> <span class=\"kw1\">return</span> <span class=\"kw2\">false</span><span class=\"sy0\">;</span><br/>    MYSQL <span class=\"sy0\">*</span>myp <span class=\"sy0\">=</span> mysql_real_connect<span class=\"br0\">(</span>mysql<span class=\"sy0\">,</span> host<span class=\"sy0\">,</span> user<span class=\"sy0\">,</span> pwd<span class=\"sy0\">,</span> db<span class=\"sy0\">,</span> port<span class=\"sy0\">,</span> NULL<span class=\"sy0\">,</span> <span class=\"nu0\">0</span><span class=\"br0\">)</span><span class=\"sy0\">;</span><br/>    <span class=\"kw1\">if</span> <span class=\"br0\">(</span>myp <span class=\"sy0\">==</span> NULL<span class=\"br0\">)</span> <span class=\"br0\">{</span><br/>      <a href=\"http://www.opengroup.org/onlinepubs/009695399/functions/fprintf.html\"><span class=\"kw3\">fprintf</span></a><span class=\"br0\">(</span>stderr<span class=\"sy0\">,</span> <span class=\"st0\">\"connection error:\u00a0%s<span class=\"es1\">\\n</span>\"</span><span class=\"sy0\">,</span> mysql_error<span class=\"br0\">(</span>mysql<span class=\"br0\">)</span><span class=\"br0\">)</span><span class=\"sy0\">;</span><br/>      end_with_db<span class=\"br0\">(</span><span class=\"br0\">)</span><span class=\"sy0\">;</span><br/>      <span class=\"kw1\">return</span> <span class=\"kw2\">false</span><span class=\"sy0\">;</span><br/>    <span class=\"br0\">}</span><br/>  <span class=\"br0\">}</span><br/>  <span class=\"kw1\">return</span> <span class=\"kw2\">true</span><span class=\"sy0\">;</span> <span class=\"co1\">// already connected...\u00a0?</span><br/><span class=\"br0\">}</span><br/>\u00a0<br/><span class=\"co2\">#define USERNAMELIMIT 32</span><br/><span class=\"co1\">// no part of the spec, but it is reasonable!!</span><br/><span class=\"co2\">#define PASSWORDLIMIT 32</span><br/><span class=\"co2\">#define SALTBYTE 16</span><br/>bool create_user<span class=\"br0\">(</span><span class=\"kw4\">const</span> <span class=\"kw4\">char</span> <span class=\"sy0\">*</span>username<span class=\"sy0\">,</span> <span class=\"kw4\">const</span> <span class=\"kw4\">char</span> <span class=\"sy0\">*</span>password<span class=\"br0\">)</span><br/><span class=\"br0\">{</span><br/>  <span class=\"kw4\">int</span> i<span class=\"sy0\">;</span><br/>  <span class=\"kw4\">char</span> binarysalt<span class=\"br0\">[</span>SALTBYTE<span class=\"br0\">]</span><span class=\"sy0\">;</span><br/>  <span class=\"kw4\">char</span> salt<span class=\"br0\">[</span>SALTBYTE<span class=\"sy0\">*</span><span class=\"nu0\">2</span><span class=\"sy0\">+</span><span class=\"nu0\">1</span><span class=\"br0\">]</span><span class=\"sy0\">;</span><br/>  <span class=\"kw4\">char</span> md5hash<span class=\"br0\">[</span>MD5_DIGEST_LENGTH<span class=\"br0\">]</span><span class=\"sy0\">;</span><br/>  <span class=\"kw4\">char</span> saltpass<span class=\"br0\">[</span>SALTBYTE<span class=\"sy0\">+</span>PASSWORDLIMIT<span class=\"sy0\">+</span><span class=\"nu0\">1</span><span class=\"br0\">]</span><span class=\"sy0\">;</span><br/>  <span class=\"kw4\">char</span> pass_md5<span class=\"br0\">[</span>MD5_DIGEST_LENGTH<span class=\"sy0\">*</span><span class=\"nu0\">2</span> <span class=\"sy0\">+</span> <span class=\"nu0\">1</span><span class=\"br0\">]</span><span class=\"sy0\">;</span><br/>  <span class=\"kw4\">char</span> user<span class=\"br0\">[</span>USERNAMELIMIT<span class=\"sy0\">*</span><span class=\"nu0\">2</span> <span class=\"sy0\">+</span> <span class=\"nu0\">1</span><span class=\"br0\">]</span><span class=\"sy0\">;</span><br/>  <span class=\"kw4\">char</span> <span class=\"sy0\">*</span>q <span class=\"sy0\">=</span> NULL<span class=\"sy0\">;</span><br/>  <span class=\"kw4\">static</span> <span class=\"kw4\">const</span> <span class=\"kw4\">char</span> query<span class=\"br0\">[</span><span class=\"br0\">]</span> <span class=\"sy0\">=</span> <br/>    <span class=\"st0\">\"INSERT INTO users \"</span><br/>    <span class=\"st0\">\"(username,pass_salt,pass_md5) \"</span><br/>    <span class=\"st0\">\"VALUES ('%s', X'%s', X'%s')\"</span><span class=\"sy0\">;</span><br/>  <span class=\"kw4\">static</span> <span class=\"kw4\">const</span> <span class=\"kw4\">size_t</span> qlen <span class=\"sy0\">=</span> <span class=\"kw4\">sizeof</span> query<span class=\"sy0\">;</span><br/>\u00a0<br/>\u00a0<br/>  <span class=\"kw1\">for</span><span class=\"br0\">(</span>i<span class=\"sy0\">=</span><span class=\"nu0\">0</span><span class=\"sy0\">;</span> username<span class=\"br0\">[</span>i<span class=\"br0\">]</span> <span class=\"sy0\">!=</span> <span class=\"st0\">'<span class=\"es5\">\\0</span>'</span> <span class=\"sy0\">&amp;&amp;</span> i <span class=\"sy0\">&lt;</span> USERNAMELIMIT<span class=\"sy0\">;</span> i<span class=\"sy0\">++</span><span class=\"br0\">)</span> <span class=\"sy0\">;</span><br/>  <span class=\"kw1\">if</span> <span class=\"br0\">(</span> username<span class=\"br0\">[</span>i<span class=\"br0\">]</span> <span class=\"sy0\">!=</span> <span class=\"st0\">'<span class=\"es5\">\\0</span>'</span> <span class=\"br0\">)</span> <span class=\"kw1\">return</span> <span class=\"kw2\">false</span><span class=\"sy0\">;</span><br/>  <span class=\"kw1\">for</span><span class=\"br0\">(</span>i<span class=\"sy0\">=</span><span class=\"nu0\">0</span><span class=\"sy0\">;</span> password<span class=\"br0\">[</span>i<span class=\"br0\">]</span> <span class=\"sy0\">!=</span> <span class=\"st0\">'<span class=\"es5\">\\0</span>'</span> <span class=\"sy0\">&amp;&amp;</span> i <span class=\"sy0\">&lt;</span> PASSWORDLIMIT<span class=\"sy0\">;</span> i<span class=\"sy0\">++</span><span class=\"br0\">)</span> <span class=\"sy0\">;</span><br/>  <span class=\"kw1\">if</span> <span class=\"br0\">(</span> password<span class=\"br0\">[</span>i<span class=\"br0\">]</span> <span class=\"sy0\">!=</span> <span class=\"st0\">'<span class=\"es5\">\\0</span>'</span> <span class=\"br0\">)</span> <span class=\"kw1\">return</span> <span class=\"kw2\">false</span><span class=\"sy0\">;</span><br/>\u00a0<br/>  <a href=\"http://www.opengroup.org/onlinepubs/009695399/functions/srand.html\"><span class=\"kw3\">srand</span></a><span class=\"br0\">(</span><a href=\"http://www.opengroup.org/onlinepubs/009695399/functions/time.html\"><span class=\"kw3\">time</span></a><span class=\"br0\">(</span>NULL<span class=\"br0\">)</span><span class=\"br0\">)</span><span class=\"sy0\">;</span><br/>\u00a0<br/>  <span class=\"kw1\">for</span><span class=\"br0\">(</span>i<span class=\"sy0\">=</span><span class=\"nu0\">0</span><span class=\"sy0\">;</span> i <span class=\"sy0\">&lt;</span> SALTBYTE<span class=\"sy0\">;</span> i<span class=\"sy0\">++</span><span class=\"br0\">)</span><br/>  <span class=\"br0\">{</span><br/>    <span class=\"co1\">// this skews the distribution but it is lazyness-compliant;)</span><br/>    binarysalt<span class=\"br0\">[</span>i<span class=\"br0\">]</span> <span class=\"sy0\">=</span> <a href=\"http://www.opengroup.org/onlinepubs/009695399/functions/rand.html\"><span class=\"kw3\">rand</span></a><span class=\"br0\">(</span><span class=\"br0\">)</span><span class=\"sy0\">%</span><span class=\"nu19\">256</span><span class=\"sy0\">;</span> <br/>  <span class=\"br0\">}</span><br/>\u00a0<br/>  <span class=\"br0\">(</span><span class=\"kw4\">void</span><span class=\"br0\">)</span>mysql_hex_string<span class=\"br0\">(</span>salt<span class=\"sy0\">,</span> binarysalt<span class=\"sy0\">,</span> SALTBYTE<span class=\"br0\">)</span><span class=\"sy0\">;</span><br/>\u00a0<br/>  <span class=\"kw1\">for</span><span class=\"br0\">(</span>i<span class=\"sy0\">=</span><span class=\"nu0\">0</span><span class=\"sy0\">;</span> i <span class=\"sy0\">&lt;</span> SALTBYTE<span class=\"sy0\">;</span> i<span class=\"sy0\">++</span><span class=\"br0\">)</span> saltpass<span class=\"br0\">[</span>i<span class=\"br0\">]</span> <span class=\"sy0\">=</span> binarysalt<span class=\"br0\">[</span>i<span class=\"br0\">]</span><span class=\"sy0\">;</span><br/>  <a href=\"http://www.opengroup.org/onlinepubs/009695399/functions/strcpy.html\"><span class=\"kw3\">strcpy</span></a><span class=\"br0\">(</span>saltpass<span class=\"sy0\">+</span>SALTBYTE<span class=\"sy0\">,</span> password<span class=\"br0\">)</span><span class=\"sy0\">;</span><br/>  <span class=\"br0\">(</span><span class=\"kw4\">void</span><span class=\"br0\">)</span>MD5<span class=\"br0\">(</span>saltpass<span class=\"sy0\">,</span> SALTBYTE <span class=\"sy0\">+</span> <a href=\"http://www.opengroup.org/onlinepubs/009695399/functions/strlen.html\"><span class=\"kw3\">strlen</span></a><span class=\"br0\">(</span>password<span class=\"br0\">)</span><span class=\"sy0\">,</span> md5hash<span class=\"br0\">)</span><span class=\"sy0\">;</span><br/>  <span class=\"br0\">(</span><span class=\"kw4\">void</span><span class=\"br0\">)</span>mysql_hex_string<span class=\"br0\">(</span>pass_md5<span class=\"sy0\">,</span> md5hash<span class=\"sy0\">,</span> MD5_DIGEST_LENGTH<span class=\"br0\">)</span><span class=\"sy0\">;</span><br/>\u00a0<br/>  <span class=\"br0\">(</span><span class=\"kw4\">void</span><span class=\"br0\">)</span>mysql_real_escape_string<span class=\"br0\">(</span>mysql<span class=\"sy0\">,</span> user<span class=\"sy0\">,</span> username<span class=\"sy0\">,</span> <a href=\"http://www.opengroup.org/onlinepubs/009695399/functions/strlen.html\"><span class=\"kw3\">strlen</span></a><span class=\"br0\">(</span>username<span class=\"br0\">)</span><span class=\"br0\">)</span><span class=\"sy0\">;</span><br/>\u00a0<br/>  <span class=\"co1\">// salt, pass_md5, user are db-query-ready</span><br/>  q <span class=\"sy0\">=</span> <a href=\"http://www.opengroup.org/onlinepubs/009695399/functions/malloc.html\"><span class=\"kw3\">malloc</span></a><span class=\"br0\">(</span>qlen <span class=\"sy0\">+</span> USERNAMELIMIT<span class=\"sy0\">*</span><span class=\"nu0\">2</span> <span class=\"sy0\">+</span> MD5_DIGEST_LENGTH<span class=\"sy0\">*</span><span class=\"nu0\">2</span> <span class=\"sy0\">+</span> SALTBYTE<span class=\"sy0\">*</span><span class=\"nu0\">2</span> <span class=\"sy0\">+</span> <span class=\"nu0\">1</span><span class=\"br0\">)</span><span class=\"sy0\">;</span><br/>  <span class=\"kw1\">if</span> <span class=\"br0\">(</span> q <span class=\"sy0\">==</span> NULL <span class=\"br0\">)</span> <span class=\"kw1\">return</span> <span class=\"kw2\">false</span><span class=\"sy0\">;</span><br/>  <a href=\"http://www.opengroup.org/onlinepubs/009695399/functions/sprintf.html\"><span class=\"kw3\">sprintf</span></a><span class=\"br0\">(</span>q<span class=\"sy0\">,</span> query<span class=\"sy0\">,</span> user<span class=\"sy0\">,</span> salt<span class=\"sy0\">,</span> pass_md5<span class=\"br0\">)</span><span class=\"sy0\">;</span><br/><span class=\"co2\">#if defined(DEBUG)</span><br/>  <a href=\"http://www.opengroup.org/onlinepubs/009695399/functions/fprintf.html\"><span class=\"kw3\">fprintf</span></a><span class=\"br0\">(</span>stderr<span class=\"sy0\">,</span> <span class=\"st0\">\"QUERY:<span class=\"es1\">\\n</span>%s<span class=\"es1\">\\n</span><span class=\"es1\">\\n</span>\"</span><span class=\"sy0\">,</span> q<span class=\"br0\">)</span><span class=\"sy0\">;</span><br/><span class=\"co2\">#endif</span><br/>  <span class=\"kw4\">int</span> res <span class=\"sy0\">=</span> mysql_query<span class=\"br0\">(</span>mysql<span class=\"sy0\">,</span> q<span class=\"br0\">)</span><span class=\"sy0\">;</span><br/>  <a href=\"http://www.opengroup.org/onlinepubs/009695399/functions/free.html\"><span class=\"kw3\">free</span></a><span class=\"br0\">(</span>q<span class=\"br0\">)</span><span class=\"sy0\">;</span><br/>  <span class=\"kw1\">if</span> <span class=\"br0\">(</span> res <span class=\"sy0\">!=</span> <span class=\"nu0\">0</span> <span class=\"br0\">)</span><br/>  <span class=\"br0\">{</span><br/>    <a href=\"http://www.opengroup.org/onlinepubs/009695399/functions/fprintf.html\"><span class=\"kw3\">fprintf</span></a><span class=\"br0\">(</span>stderr<span class=\"sy0\">,</span> <span class=\"st0\">\"create_user query error:\u00a0%s<span class=\"es1\">\\n</span>\"</span><span class=\"sy0\">,</span> mysql_error<span class=\"br0\">(</span>mysql<span class=\"br0\">)</span><span class=\"br0\">)</span><span class=\"sy0\">;</span><br/>    <span class=\"kw1\">return</span> <span class=\"kw2\">false</span><span class=\"sy0\">;</span><br/>  <span class=\"br0\">}</span><br/>  <span class=\"kw1\">return</span> <span class=\"kw2\">true</span><span class=\"sy0\">;</span><br/><span class=\"br0\">}</span><br/>\u00a0<br/>\u00a0<br/>bool authenticate_user<span class=\"br0\">(</span><span class=\"kw4\">const</span> <span class=\"kw4\">char</span> <span class=\"sy0\">*</span>username<span class=\"sy0\">,</span> <span class=\"kw4\">const</span> <span class=\"kw4\">char</span> <span class=\"sy0\">*</span>password<span class=\"br0\">)</span><br/><span class=\"br0\">{</span><br/>  <span class=\"kw4\">char</span> user<span class=\"br0\">[</span>USERNAMELIMIT<span class=\"sy0\">*</span><span class=\"nu0\">2</span> <span class=\"sy0\">+</span> <span class=\"nu0\">1</span><span class=\"br0\">]</span><span class=\"sy0\">;</span><br/>  <span class=\"kw4\">char</span> md5hash<span class=\"br0\">[</span>MD5_DIGEST_LENGTH<span class=\"br0\">]</span><span class=\"sy0\">;</span><br/>  <span class=\"kw4\">char</span> saltpass<span class=\"br0\">[</span>SALTBYTE<span class=\"sy0\">+</span>PASSWORDLIMIT<span class=\"sy0\">+</span><span class=\"nu0\">1</span><span class=\"br0\">]</span><span class=\"sy0\">;</span><br/>  bool authok <span class=\"sy0\">=</span> <span class=\"kw2\">false</span><span class=\"sy0\">;</span><br/>  <span class=\"kw4\">char</span> <span class=\"sy0\">*</span>q <span class=\"sy0\">=</span> NULL<span class=\"sy0\">;</span><br/>  <span class=\"kw4\">int</span> i<span class=\"sy0\">;</span><br/>  <span class=\"kw4\">static</span> <span class=\"kw4\">const</span> <span class=\"kw4\">char</span> query<span class=\"br0\">[</span><span class=\"br0\">]</span> <span class=\"sy0\">=</span> <br/>    <span class=\"st0\">\"SELECT * FROM users WHERE username='%s'\"</span><span class=\"sy0\">;</span><br/>  <span class=\"kw4\">static</span> <span class=\"kw4\">const</span> <span class=\"kw4\">size_t</span> qlen <span class=\"sy0\">=</span> <span class=\"kw4\">sizeof</span> query<span class=\"sy0\">;</span><br/>\u00a0<br/>  <span class=\"co1\">// can't be authenticated with invalid username or password</span><br/>  <span class=\"kw1\">for</span><span class=\"br0\">(</span>i<span class=\"sy0\">=</span><span class=\"nu0\">0</span><span class=\"sy0\">;</span> username<span class=\"br0\">[</span>i<span class=\"br0\">]</span> <span class=\"sy0\">!=</span> <span class=\"st0\">'<span class=\"es5\">\\0</span>'</span> <span class=\"sy0\">&amp;&amp;</span> i <span class=\"sy0\">&lt;</span> USERNAMELIMIT<span class=\"sy0\">;</span> i<span class=\"sy0\">++</span><span class=\"br0\">)</span> <span class=\"sy0\">;</span><br/>  <span class=\"kw1\">if</span> <span class=\"br0\">(</span> username<span class=\"br0\">[</span>i<span class=\"br0\">]</span> <span class=\"sy0\">!=</span> <span class=\"st0\">'<span class=\"es5\">\\0</span>'</span> <span class=\"br0\">)</span> <span class=\"kw1\">return</span> <span class=\"kw2\">false</span><span class=\"sy0\">;</span><br/>  <span class=\"kw1\">for</span><span class=\"br0\">(</span>i<span class=\"sy0\">=</span><span class=\"nu0\">0</span><span class=\"sy0\">;</span> password<span class=\"br0\">[</span>i<span class=\"br0\">]</span> <span class=\"sy0\">!=</span> <span class=\"st0\">'<span class=\"es5\">\\0</span>'</span> <span class=\"sy0\">&amp;&amp;</span> i <span class=\"sy0\">&lt;</span> PASSWORDLIMIT<span class=\"sy0\">;</span> i<span class=\"sy0\">++</span><span class=\"br0\">)</span> <span class=\"sy0\">;</span><br/>  <span class=\"kw1\">if</span> <span class=\"br0\">(</span> password<span class=\"br0\">[</span>i<span class=\"br0\">]</span> <span class=\"sy0\">!=</span> <span class=\"st0\">'<span class=\"es5\">\\0</span>'</span> <span class=\"br0\">)</span> <span class=\"kw1\">return</span> <span class=\"kw2\">false</span><span class=\"sy0\">;</span><br/>\u00a0<br/>  <span class=\"br0\">(</span><span class=\"kw4\">void</span><span class=\"br0\">)</span>mysql_real_escape_string<span class=\"br0\">(</span>mysql<span class=\"sy0\">,</span> user<span class=\"sy0\">,</span> username<span class=\"sy0\">,</span> <a href=\"http://www.opengroup.org/onlinepubs/009695399/functions/strlen.html\"><span class=\"kw3\">strlen</span></a><span class=\"br0\">(</span>username<span class=\"br0\">)</span><span class=\"br0\">)</span><span class=\"sy0\">;</span>  <br/>\u00a0<br/>  q <span class=\"sy0\">=</span> <a href=\"http://www.opengroup.org/onlinepubs/009695399/functions/malloc.html\"><span class=\"kw3\">malloc</span></a><span class=\"br0\">(</span>qlen <span class=\"sy0\">+</span> <a href=\"http://www.opengroup.org/onlinepubs/009695399/functions/strlen.html\"><span class=\"kw3\">strlen</span></a><span class=\"br0\">(</span>user<span class=\"br0\">)</span> <span class=\"sy0\">+</span> <span class=\"nu0\">1</span><span class=\"br0\">)</span><span class=\"sy0\">;</span><br/>  <span class=\"kw1\">if</span> <span class=\"br0\">(</span>q <span class=\"sy0\">==</span> NULL<span class=\"br0\">)</span> <span class=\"kw1\">return</span> <span class=\"kw2\">false</span><span class=\"sy0\">;</span><br/>  <a href=\"http://www.opengroup.org/onlinepubs/009695399/functions/sprintf.html\"><span class=\"kw3\">sprintf</span></a><span class=\"br0\">(</span>q<span class=\"sy0\">,</span> query<span class=\"sy0\">,</span> username<span class=\"br0\">)</span><span class=\"sy0\">;</span><br/>\u00a0<br/>  <span class=\"kw4\">int</span> res <span class=\"sy0\">=</span> mysql_query<span class=\"br0\">(</span>mysql<span class=\"sy0\">,</span> q<span class=\"br0\">)</span><span class=\"sy0\">;</span><br/>  <a href=\"http://www.opengroup.org/onlinepubs/009695399/functions/free.html\"><span class=\"kw3\">free</span></a><span class=\"br0\">(</span>q<span class=\"br0\">)</span><span class=\"sy0\">;</span><br/>  <span class=\"kw1\">if</span> <span class=\"br0\">(</span> res <span class=\"sy0\">!=</span> <span class=\"nu0\">0</span> <span class=\"br0\">)</span><br/>  <span class=\"br0\">{</span><br/>    <a href=\"http://www.opengroup.org/onlinepubs/009695399/functions/fprintf.html\"><span class=\"kw3\">fprintf</span></a><span class=\"br0\">(</span>stderr<span class=\"sy0\">,</span> <span class=\"st0\">\"authenticate_user query error:\u00a0%s<span class=\"es1\">\\n</span>\"</span><span class=\"sy0\">,</span> mysql_error<span class=\"br0\">(</span>mysql<span class=\"br0\">)</span><span class=\"br0\">)</span><span class=\"sy0\">;</span><br/>    <span class=\"kw1\">return</span> <span class=\"kw2\">false</span><span class=\"sy0\">;</span><br/>  <span class=\"br0\">}</span><br/>\u00a0<br/>  MYSQL_RES <span class=\"sy0\">*</span>qr <span class=\"sy0\">=</span> mysql_store_result<span class=\"br0\">(</span>mysql<span class=\"br0\">)</span><span class=\"sy0\">;</span><br/>  <span class=\"kw1\">if</span> <span class=\"br0\">(</span> qr <span class=\"sy0\">==</span> NULL <span class=\"br0\">)</span> <span class=\"kw1\">return</span> <span class=\"kw2\">false</span><span class=\"sy0\">;</span><br/>\u00a0<br/>  <span class=\"co1\">// should be only a result, or none</span><br/>  <span class=\"kw1\">if</span> <span class=\"br0\">(</span> mysql_num_rows<span class=\"br0\">(</span>qr<span class=\"br0\">)</span> <span class=\"sy0\">!=</span> <span class=\"nu0\">1</span> <span class=\"br0\">)</span> <span class=\"br0\">{</span><br/>    mysql_free_result<span class=\"br0\">(</span>qr<span class=\"br0\">)</span><span class=\"sy0\">;</span><br/>    <span class=\"kw1\">return</span> <span class=\"kw2\">false</span><span class=\"sy0\">;</span><br/>  <span class=\"br0\">}</span><br/>\u00a0<br/>  MYSQL_ROW row <span class=\"sy0\">=</span> mysql_fetch_row<span class=\"br0\">(</span>qr<span class=\"br0\">)</span><span class=\"sy0\">;</span>          <span class=\"co1\">// 1 row must exist</span><br/>  <span class=\"kw4\">unsigned</span> <span class=\"kw4\">long</span> <span class=\"sy0\">*</span>len <span class=\"sy0\">=</span> mysql_fetch_lengths<span class=\"br0\">(</span>qr<span class=\"br0\">)</span><span class=\"sy0\">;</span> <span class=\"co1\">// and should have 4 cols...</span><br/>\u00a0<br/>  <a href=\"http://www.opengroup.org/onlinepubs/009695399/functions/memcpy.html\"><span class=\"kw3\">memcpy</span></a><span class=\"br0\">(</span>saltpass<span class=\"sy0\">,</span> row<span class=\"br0\">[</span><span class=\"nu0\">2</span><span class=\"br0\">]</span><span class=\"sy0\">,</span> len<span class=\"br0\">[</span><span class=\"nu0\">2</span><span class=\"br0\">]</span><span class=\"br0\">)</span><span class=\"sy0\">;</span> <span class=\"co1\">// len[2] should be SALTBYTE</span><br/>  <a href=\"http://www.opengroup.org/onlinepubs/009695399/functions/memcpy.html\"><span class=\"kw3\">memcpy</span></a><span class=\"br0\">(</span>saltpass <span class=\"sy0\">+</span> len<span class=\"br0\">[</span><span class=\"nu0\">2</span><span class=\"br0\">]</span><span class=\"sy0\">,</span> password<span class=\"sy0\">,</span> <a href=\"http://www.opengroup.org/onlinepubs/009695399/functions/strlen.html\"><span class=\"kw3\">strlen</span></a><span class=\"br0\">(</span>password<span class=\"br0\">)</span><span class=\"br0\">)</span><span class=\"sy0\">;</span><br/>  <span class=\"br0\">(</span><span class=\"kw4\">void</span><span class=\"br0\">)</span>MD5<span class=\"br0\">(</span>saltpass<span class=\"sy0\">,</span> SALTBYTE <span class=\"sy0\">+</span> <a href=\"http://www.opengroup.org/onlinepubs/009695399/functions/strlen.html\"><span class=\"kw3\">strlen</span></a><span class=\"br0\">(</span>password<span class=\"br0\">)</span><span class=\"sy0\">,</span> md5hash<span class=\"br0\">)</span><span class=\"sy0\">;</span><br/>\u00a0<br/>  authok <span class=\"sy0\">=</span> <a href=\"http://www.opengroup.org/onlinepubs/009695399/functions/memcmp.html\"><span class=\"kw3\">memcmp</span></a><span class=\"br0\">(</span>md5hash<span class=\"sy0\">,</span> row<span class=\"br0\">[</span><span class=\"nu0\">3</span><span class=\"br0\">]</span><span class=\"sy0\">,</span> len<span class=\"br0\">[</span><span class=\"nu0\">3</span><span class=\"br0\">]</span><span class=\"br0\">)</span> <span class=\"sy0\">==</span> <span class=\"nu0\">0</span><span class=\"sy0\">;</span><br/>  mysql_free_result<span class=\"br0\">(</span>qr<span class=\"br0\">)</span><span class=\"sy0\">;</span><br/>\u00a0<br/>  <span class=\"kw1\">return</span> authok<span class=\"sy0\">;</span><br/><span class=\"br0\">}</span><br/>\u00a0<br/><span class=\"kw4\">void</span> end_with_db<span class=\"br0\">(</span><span class=\"kw4\">void</span><span class=\"br0\">)</span><br/><span class=\"br0\">{</span><br/>  mysql_close<span class=\"br0\">(</span>mysql<span class=\"br0\">)</span><span class=\"sy0\">;</span> mysql <span class=\"sy0\">=</span> NULL<span class=\"sy0\">;</span><br/>  mysql_library_end<span class=\"br0\">(</span><span class=\"br0\">)</span><span class=\"sy0\">;</span><br/><span class=\"br0\">}</span><br/>\u00a0<br/><span class=\"kw4\">int</span> main<span class=\"br0\">(</span><span class=\"kw4\">int</span> argc<span class=\"sy0\">,</span> <span class=\"kw4\">char</span> <span class=\"sy0\">**</span>argv<span class=\"br0\">)</span><br/><span class=\"br0\">{</span><br/>\u00a0<br/>  <span class=\"kw1\">if</span> <span class=\"br0\">(</span> argc <span class=\"sy0\">&lt;</span> <span class=\"nu0\">4</span> <span class=\"br0\">)</span> <span class=\"kw1\">return</span> EXIT_FAILURE<span class=\"sy0\">;</span><br/>\u00a0<br/>  <span class=\"kw1\">if</span> <span class=\"br0\">(</span> connect_db<span class=\"br0\">(</span><span class=\"st0\">\"localhost\"</span><span class=\"sy0\">,</span> <span class=\"st0\">\"devel\"</span><span class=\"sy0\">,</span> <span class=\"st0\">\"\"</span><span class=\"sy0\">,</span> <span class=\"st0\">\"test\"</span><span class=\"sy0\">,</span> <span class=\"nu0\">0</span> <span class=\"br0\">)</span> <span class=\"br0\">)</span><br/>  <span class=\"br0\">{</span><br/>    <span class=\"kw1\">if</span> <span class=\"br0\">(</span> <a href=\"http://www.opengroup.org/onlinepubs/009695399/functions/strcmp.html\"><span class=\"kw3\">strcmp</span></a><span class=\"br0\">(</span>argv<span class=\"br0\">[</span><span class=\"nu0\">1</span><span class=\"br0\">]</span><span class=\"sy0\">,</span> <span class=\"st0\">\"add\"</span><span class=\"br0\">)</span> <span class=\"sy0\">==</span> <span class=\"nu0\">0</span> <span class=\"br0\">)</span><br/>    <span class=\"br0\">{</span><br/>      <span class=\"kw1\">if</span> <span class=\"br0\">(</span>create_user<span class=\"br0\">(</span>argv<span class=\"br0\">[</span><span class=\"nu0\">2</span><span class=\"br0\">]</span><span class=\"sy0\">,</span> argv<span class=\"br0\">[</span><span class=\"nu0\">3</span><span class=\"br0\">]</span><span class=\"br0\">)</span><span class=\"br0\">)</span> <br/>\t<a href=\"http://www.opengroup.org/onlinepubs/009695399/functions/printf.html\"><span class=\"kw3\">printf</span></a><span class=\"br0\">(</span><span class=\"st0\">\"created<span class=\"es1\">\\n</span>\"</span><span class=\"br0\">)</span><span class=\"sy0\">;</span><br/>    <span class=\"br0\">}</span> <span class=\"kw1\">else</span> <span class=\"kw1\">if</span> <span class=\"br0\">(</span> <a href=\"http://www.opengroup.org/onlinepubs/009695399/functions/strcmp.html\"><span class=\"kw3\">strcmp</span></a><span class=\"br0\">(</span>argv<span class=\"br0\">[</span><span class=\"nu0\">1</span><span class=\"br0\">]</span><span class=\"sy0\">,</span> <span class=\"st0\">\"auth\"</span><span class=\"br0\">)</span> <span class=\"sy0\">==</span> <span class=\"nu0\">0</span> <span class=\"br0\">)</span> <span class=\"br0\">{</span><br/>      <span class=\"kw1\">if</span> <span class=\"br0\">(</span>authenticate_user<span class=\"br0\">(</span>argv<span class=\"br0\">[</span><span class=\"nu0\">2</span><span class=\"br0\">]</span><span class=\"sy0\">,</span> argv<span class=\"br0\">[</span><span class=\"nu0\">3</span><span class=\"br0\">]</span><span class=\"br0\">)</span><span class=\"br0\">)</span><br/>\t<a href=\"http://www.opengroup.org/onlinepubs/009695399/functions/printf.html\"><span class=\"kw3\">printf</span></a><span class=\"br0\">(</span><span class=\"st0\">\"authorized<span class=\"es1\">\\n</span>\"</span><span class=\"br0\">)</span><span class=\"sy0\">;</span><br/>      <span class=\"kw1\">else</span><br/>\t<a href=\"http://www.opengroup.org/onlinepubs/009695399/functions/printf.html\"><span class=\"kw3\">printf</span></a><span class=\"br0\">(</span><span class=\"st0\">\"access denied<span class=\"es1\">\\n</span>\"</span><span class=\"br0\">)</span><span class=\"sy0\">;</span><br/>    <span class=\"br0\">}</span> <span class=\"kw1\">else</span> <span class=\"br0\">{</span><br/>      <a href=\"http://www.opengroup.org/onlinepubs/009695399/functions/printf.html\"><span class=\"kw3\">printf</span></a><span class=\"br0\">(</span><span class=\"st0\">\"unknown command<span class=\"es1\">\\n</span>\"</span><span class=\"br0\">)</span><span class=\"sy0\">;</span><br/>    <span class=\"br0\">}</span><br/>    end_with_db<span class=\"br0\">(</span><span class=\"br0\">)</span><span class=\"sy0\">;</span><br/>  <span class=\"br0\">}</span><br/>  <span class=\"kw1\">return</span> EXIT_SUCCESS<span class=\"sy0\">;</span><br/><span class=\"br0\">}</span></pre>"}, {"lang": "Go", "loc": 79, "block": "<pre class=\"go highlighted_source\"><span class=\"kw1\">package</span> main<br/>\u00a0<br/><span class=\"kw1\">import</span> <span class=\"sy1\">(</span><br/>    <span class=\"st0\">\"bytes\"</span><br/>    <span class=\"st0\">\"crypto/md5\"</span><br/>    <span class=\"st0\">\"crypto/rand\"</span><br/>    <span class=\"st0\">\"database/sql\"</span><br/>    <span class=\"st0\">\"fmt\"</span><br/>\u00a0<br/>    _ <span class=\"st0\">\"github.com/go-sql-driver/mysql\"</span><br/><span class=\"sy1\">)</span><br/>\u00a0<br/><span class=\"kw4\">func</span> connectDB<span class=\"sy1\">()</span> <span class=\"sy1\">(</span><span class=\"sy3\">*</span>sql<span class=\"sy3\">.</span>DB<span class=\"sy1\">,</span> error<span class=\"sy1\">)</span> <span class=\"sy1\">{</span><br/>    <span class=\"kw1\">return</span> sql<span class=\"sy3\">.</span>Open<span class=\"sy1\">(</span><span class=\"st0\">\"mysql\"</span><span class=\"sy1\">,</span> <span class=\"st0\">\"rosetta:<a class=\"__cf_email__\" data-cfemail=\"e5868a8180a5\" href=\"/cdn-cgi/l/email-protection\">[email\u00a0protected]</a>/rc\"</span><span class=\"sy1\">)</span><br/><span class=\"sy1\">}</span><br/>\u00a0<br/><span class=\"kw4\">func</span> createUser<span class=\"sy1\">(</span>db <span class=\"sy3\">*</span>sql<span class=\"sy3\">.</span>DB<span class=\"sy1\">,</span> user<span class=\"sy1\">,</span> pwd <span class=\"kw4\">string</span><span class=\"sy1\">)</span> error <span class=\"sy1\">{</span><br/>    salt <span class=\"sy2\">:=</span> <span class=\"kw3\">make</span><span class=\"sy1\">([]</span><span class=\"kw4\">byte</span><span class=\"sy1\">,</span> <span class=\"nu0\">16</span><span class=\"sy1\">)</span><br/>    rand<span class=\"sy3\">.</span>Reader<span class=\"sy3\">.</span>Read<span class=\"sy1\">(</span>salt<span class=\"sy1\">)</span><br/>    _<span class=\"sy1\">,</span> err <span class=\"sy2\">:=</span> db<span class=\"sy3\">.</span>Exec<span class=\"sy1\">(</span><span class=\"co2\">`insert into users (username, pass_salt, pass_md5)<br/>        values (?,\u00a0?,\u00a0?)`</span><span class=\"sy1\">,</span> user<span class=\"sy1\">,</span> salt<span class=\"sy1\">,</span> saltHash<span class=\"sy1\">(</span>salt<span class=\"sy1\">,</span> pwd<span class=\"sy1\">))</span><br/>    <span class=\"kw1\">if</span> err <span class=\"sy2\">!=</span> <span class=\"kw2\">nil</span> <span class=\"sy1\">{</span><br/>        <span class=\"kw1\">return</span> fmt<span class=\"sy3\">.</span>Errorf<span class=\"sy1\">(</span><span class=\"st0\">\"User\u00a0%s already exits\"</span><span class=\"sy1\">,</span> user<span class=\"sy1\">)</span><br/>    <span class=\"sy1\">}</span><br/>    <span class=\"kw1\">return</span> <span class=\"kw2\">nil</span><br/><span class=\"sy1\">}</span><br/>\u00a0<br/><span class=\"kw4\">func</span> authenticateUser<span class=\"sy1\">(</span>db <span class=\"sy3\">*</span>sql<span class=\"sy3\">.</span>DB<span class=\"sy1\">,</span> user<span class=\"sy1\">,</span> pwd <span class=\"kw4\">string</span><span class=\"sy1\">)</span> error <span class=\"sy1\">{</span><br/>    <span class=\"kw1\">var</span> salt<span class=\"sy1\">,</span> hash <span class=\"sy1\">[]</span><span class=\"kw4\">byte</span><br/>    row <span class=\"sy2\">:=</span> db<span class=\"sy3\">.</span>QueryRow<span class=\"sy1\">(</span><span class=\"co2\">`select pass_salt, pass_md5 from users<br/>        where username=?`</span><span class=\"sy1\">,</span> user<span class=\"sy1\">)</span><br/>    <span class=\"kw1\">if</span> err <span class=\"sy2\">:=</span> row<span class=\"sy3\">.</span>Scan<span class=\"sy1\">(</span>&amp;salt<span class=\"sy1\">,</span> &amp;hash<span class=\"sy1\">);</span> err <span class=\"sy2\">!=</span> <span class=\"kw2\">nil</span> <span class=\"sy1\">{</span><br/>        <span class=\"kw1\">return</span> fmt<span class=\"sy3\">.</span>Errorf<span class=\"sy1\">(</span><span class=\"st0\">\"User\u00a0%s unknown\"</span><span class=\"sy1\">,</span> user<span class=\"sy1\">)</span><br/>    <span class=\"sy1\">}</span><br/>    <span class=\"kw1\">if</span> <span class=\"sy3\">!</span>bytes<span class=\"sy3\">.</span>Equal<span class=\"sy1\">(</span>saltHash<span class=\"sy1\">(</span>salt<span class=\"sy1\">,</span> pwd<span class=\"sy1\">),</span> hash<span class=\"sy1\">)</span> <span class=\"sy1\">{</span><br/>        <span class=\"kw1\">return</span> fmt<span class=\"sy3\">.</span>Errorf<span class=\"sy1\">(</span><span class=\"st0\">\"User\u00a0%s invalid password\"</span><span class=\"sy1\">,</span> user<span class=\"sy1\">)</span><br/>    <span class=\"sy1\">}</span><br/>    <span class=\"kw1\">return</span> <span class=\"kw2\">nil</span><br/><span class=\"sy1\">}</span><br/>\u00a0<br/><span class=\"kw4\">func</span> saltHash<span class=\"sy1\">(</span>salt <span class=\"sy1\">[]</span><span class=\"kw4\">byte</span><span class=\"sy1\">,</span> pwd <span class=\"kw4\">string</span><span class=\"sy1\">)</span> <span class=\"sy1\">[]</span><span class=\"kw4\">byte</span> <span class=\"sy1\">{</span><br/>    h <span class=\"sy2\">:=</span> md5<span class=\"sy3\">.</span>New<span class=\"sy1\">()</span><br/>    h<span class=\"sy3\">.</span>Write<span class=\"sy1\">(</span>salt<span class=\"sy1\">)</span><br/>    h<span class=\"sy3\">.</span>Write<span class=\"sy1\">([]</span><span class=\"kw4\">byte</span><span class=\"sy1\">(</span>pwd<span class=\"sy1\">))</span><br/>    <span class=\"kw1\">return</span> h<span class=\"sy3\">.</span>Sum<span class=\"sy1\">(</span><span class=\"kw2\">nil</span><span class=\"sy1\">)</span><br/><span class=\"sy1\">}</span><br/>\u00a0<br/><span class=\"kw4\">func</span> main<span class=\"sy1\">()</span> <span class=\"sy1\">{</span><br/>    <span class=\"co1\">// demonstrate</span><br/>    db<span class=\"sy1\">,</span> err <span class=\"sy2\">:=</span> connectDB<span class=\"sy1\">()</span><br/>    <span class=\"kw1\">defer</span> db<span class=\"sy3\">.</span>Close<span class=\"sy1\">()</span><br/>    createUser<span class=\"sy1\">(</span>db<span class=\"sy1\">,</span> <span class=\"st0\">\"sam\"</span><span class=\"sy1\">,</span> <span class=\"st0\">\"123\"</span><span class=\"sy1\">)</span><br/>    err <span class=\"sy2\">=</span> authenticateUser<span class=\"sy1\">(</span>db<span class=\"sy1\">,</span> <span class=\"st0\">\"sam\"</span><span class=\"sy1\">,</span> <span class=\"st0\">\"123\"</span><span class=\"sy1\">)</span><br/>    <span class=\"kw1\">if</span> err <span class=\"sy3\">==</span> <span class=\"kw2\">nil</span> <span class=\"sy1\">{</span><br/>        fmt<span class=\"sy3\">.</span>Println<span class=\"sy1\">(</span><span class=\"st0\">\"User sam authenticated\"</span><span class=\"sy1\">)</span><br/>    <span class=\"sy1\">}</span><br/>\u00a0<br/>    <span class=\"co1\">// extra</span><br/>    fmt<span class=\"sy3\">.</span><span class=\"me1\">Println</span><span class=\"sy1\">()</span><br/>    <span class=\"co1\">// show contents of database</span><br/>    rows<span class=\"sy1\">,</span> _ <span class=\"sy2\">:=</span> db<span class=\"sy3\">.</span><span class=\"me1\">Query</span><span class=\"sy1\">(</span><span class=\"co2\">`select username, pass_salt, pass_md5 from users`</span><span class=\"sy1\">)</span><br/>    <span class=\"kw1\">var</span> user <span class=\"kw4\">string</span><br/>    <span class=\"kw1\">var</span> salt<span class=\"sy1\">,</span> hash <span class=\"sy1\">[]</span><span class=\"kw4\">byte</span><br/>    <span class=\"kw1\">for</span> rows<span class=\"sy3\">.</span>Next<span class=\"sy1\">()</span> <span class=\"sy1\">{</span><br/>        rows<span class=\"sy3\">.</span>Scan<span class=\"sy1\">(</span>&amp;user<span class=\"sy1\">,</span> &amp;salt<span class=\"sy1\">,</span> &amp;hash<span class=\"sy1\">)</span><br/>        fmt<span class=\"sy3\">.</span>Printf<span class=\"sy1\">(</span><span class=\"st0\">\"%s\u00a0%x\u00a0%x<span class=\"es1\">\\n</span>\"</span><span class=\"sy1\">,</span> user<span class=\"sy1\">,</span> salt<span class=\"sy1\">,</span> hash<span class=\"sy1\">)</span><br/>    <span class=\"sy1\">}</span><br/>    <span class=\"co1\">// try creating same user again</span><br/>    err <span class=\"sy2\">=</span> createUser<span class=\"sy1\">(</span>db<span class=\"sy1\">,</span> <span class=\"st0\">\"sam\"</span><span class=\"sy1\">,</span> <span class=\"st0\">\"123\"</span><span class=\"sy1\">)</span><br/>    fmt<span class=\"sy3\">.</span><span class=\"me1\">Println</span><span class=\"sy1\">(</span>err<span class=\"sy1\">)</span><br/>    <span class=\"co1\">// try authenticating unknown user</span><br/>    err <span class=\"sy2\">=</span> authenticateUser<span class=\"sy1\">(</span>db<span class=\"sy1\">,</span> <span class=\"st0\">\"pam\"</span><span class=\"sy1\">,</span> <span class=\"st0\">\"123\"</span><span class=\"sy1\">)</span><br/>    fmt<span class=\"sy3\">.</span><span class=\"me1\">Println</span><span class=\"sy1\">(</span>err<span class=\"sy1\">)</span><br/>    <span class=\"co1\">// try wrong password</span><br/>    err <span class=\"sy2\">=</span> authenticateUser<span class=\"sy1\">(</span>db<span class=\"sy1\">,</span> <span class=\"st0\">\"sam\"</span><span class=\"sy1\">,</span> <span class=\"st0\">\"1234\"</span><span class=\"sy1\">)</span><br/>    fmt<span class=\"sy3\">.</span><span class=\"me1\">Println</span><span class=\"sy1\">(</span>err<span class=\"sy1\">)</span><br/>    <span class=\"co1\">// clear table to run program again</span><br/>    db<span class=\"sy3\">.</span><span class=\"me1\">Exec</span><span class=\"sy1\">(</span><span class=\"co2\">`truncate table users`</span><span class=\"sy1\">)</span><br/><span class=\"sy1\">}</span></pre>"}, {"lang": "Java", "loc": 142, "block": "<pre class=\"java highlighted_source\"><span class=\"kw1\">import</span> <span class=\"co2\">java.io.UnsupportedEncodingException</span><span class=\"sy0\">;</span><br/><span class=\"kw1\">import</span> <span class=\"co2\">java.sql.Connection</span><span class=\"sy0\">;</span><br/><span class=\"kw1\">import</span> <span class=\"co2\">java.sql.DriverManager</span><span class=\"sy0\">;</span><br/><span class=\"kw1\">import</span> <span class=\"co2\">java.sql.PreparedStatement</span><span class=\"sy0\">;</span><br/><span class=\"kw1\">import</span> <span class=\"co2\">java.sql.ResultSet</span><span class=\"sy0\">;</span><br/><span class=\"kw1\">import</span> <span class=\"co2\">java.sql.SQLException</span><span class=\"sy0\">;</span><br/><span class=\"kw1\">import</span> <span class=\"co2\">java.security.MessageDigest</span><span class=\"sy0\">;</span><br/><span class=\"kw1\">import</span> <span class=\"co2\">java.security.NoSuchAlgorithmException</span><span class=\"sy0\">;</span><br/><span class=\"kw1\">import</span> <span class=\"co2\">java.security.SecureRandom</span><span class=\"sy0\">;</span><br/><span class=\"kw1\">import</span> <span class=\"co2\">java.math.BigInteger</span><span class=\"sy0\">;</span><br/>\u00a0<br/>\u00a0<br/><span class=\"kw1\">class</span> UserManager <span class=\"br0\">{</span><br/>    <span class=\"kw1\">private</span> <a href=\"http://www.google.com/search?hl=en&amp;q=allinurl%3Aconnection+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky\"><span class=\"kw3\">Connection</span></a> dbConnection<span class=\"sy0\">;</span><br/>\u00a0<br/>    <span class=\"kw1\">public</span> UserManager<span class=\"br0\">(</span><span class=\"br0\">)</span> <span class=\"br0\">{</span><br/>    <span class=\"br0\">}</span><br/>\u00a0<br/>    <span class=\"kw1\">private</span> <a href=\"http://www.google.com/search?hl=en&amp;q=allinurl%3Astring+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky\"><span class=\"kw3\">String</span></a> md5<span class=\"br0\">(</span><a href=\"http://www.google.com/search?hl=en&amp;q=allinurl%3Astring+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky\"><span class=\"kw3\">String</span></a> aString<span class=\"br0\">)</span> <span class=\"kw1\">throws</span> <a href=\"http://www.google.com/search?hl=en&amp;q=allinurl%3Anosuchalgorithmexception+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky\"><span class=\"kw3\">NoSuchAlgorithmException</span></a>, <a href=\"http://www.google.com/search?hl=en&amp;q=allinurl%3Aunsupportedencodingexception+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky\"><span class=\"kw3\">UnsupportedEncodingException</span></a> <span class=\"br0\">{</span><br/>        <a href=\"http://www.google.com/search?hl=en&amp;q=allinurl%3Amessagedigest+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky\"><span class=\"kw3\">MessageDigest</span></a> md<span class=\"sy0\">;</span><br/>        <a href=\"http://www.google.com/search?hl=en&amp;q=allinurl%3Astring+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky\"><span class=\"kw3\">String</span></a> hex<span class=\"sy0\">;</span><br/>        <a href=\"http://www.google.com/search?hl=en&amp;q=allinurl%3Astringbuffer+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky\"><span class=\"kw3\">StringBuffer</span></a> hexString<span class=\"sy0\">;</span><br/>        <span class=\"kw4\">byte</span><span class=\"br0\">[</span><span class=\"br0\">]</span> bytesOfMessage<span class=\"sy0\">;</span><br/>        <span class=\"kw4\">byte</span><span class=\"br0\">[</span><span class=\"br0\">]</span> theDigest<span class=\"sy0\">;</span><br/>\u00a0<br/>        hexString <span class=\"sy0\">=</span> <span class=\"kw1\">new</span> <a href=\"http://www.google.com/search?hl=en&amp;q=allinurl%3Astringbuffer+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky\"><span class=\"kw3\">StringBuffer</span></a><span class=\"br0\">(</span><span class=\"br0\">)</span><span class=\"sy0\">;</span><br/>        bytesOfMessage <span class=\"sy0\">=</span> aString.<span class=\"me1\">getBytes</span><span class=\"br0\">(</span><span class=\"st0\">\"UTF-8\"</span><span class=\"br0\">)</span><span class=\"sy0\">;</span><br/>        md <span class=\"sy0\">=</span> <a href=\"http://www.google.com/search?hl=en&amp;q=allinurl%3Amessagedigest+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky\"><span class=\"kw3\">MessageDigest</span></a>.<span class=\"me1\">getInstance</span><span class=\"br0\">(</span><span class=\"st0\">\"MD5\"</span><span class=\"br0\">)</span><span class=\"sy0\">;</span><br/>        theDigest <span class=\"sy0\">=</span> md.<span class=\"me1\">digest</span><span class=\"br0\">(</span>bytesOfMessage<span class=\"br0\">)</span><span class=\"sy0\">;</span><br/>\u00a0<br/>        <span class=\"kw1\">for</span> <span class=\"br0\">(</span><span class=\"kw4\">int</span> i <span class=\"sy0\">=</span> <span class=\"nu0\">0</span><span class=\"sy0\">;</span> i <span class=\"sy0\">&lt;</span> theDigest.<span class=\"me1\">length</span><span class=\"sy0\">;</span> i<span class=\"sy0\">++</span><span class=\"br0\">)</span> <span class=\"br0\">{</span><br/>            hex <span class=\"sy0\">=</span> <a href=\"http://www.google.com/search?hl=en&amp;q=allinurl%3Ainteger+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky\"><span class=\"kw3\">Integer</span></a>.<span class=\"me1\">toHexString</span><span class=\"br0\">(</span>0xff <span class=\"sy0\">&amp;</span> theDigest<span class=\"br0\">[</span>i<span class=\"br0\">]</span><span class=\"br0\">)</span><span class=\"sy0\">;</span><br/>            <span class=\"kw1\">if</span> <span class=\"br0\">(</span>hex.<span class=\"me1\">length</span><span class=\"br0\">(</span><span class=\"br0\">)</span> <span class=\"sy0\">==</span> <span class=\"nu0\">1</span><span class=\"br0\">)</span> <span class=\"br0\">{</span><br/>                hexString.<span class=\"me1\">append</span><span class=\"br0\">(</span><span class=\"st0\">'0'</span><span class=\"br0\">)</span><span class=\"sy0\">;</span><br/>            <span class=\"br0\">}</span><br/>            hexString.<span class=\"me1\">append</span><span class=\"br0\">(</span>hex<span class=\"br0\">)</span><span class=\"sy0\">;</span><br/>        <span class=\"br0\">}</span><br/>\u00a0<br/>        <span class=\"kw1\">return</span> hexString.<span class=\"me1\">toString</span><span class=\"br0\">(</span><span class=\"br0\">)</span><span class=\"sy0\">;</span><br/>    <span class=\"br0\">}</span><br/>\u00a0<br/>    <span class=\"kw1\">public</span> <span class=\"kw4\">void</span> connectDB<span class=\"br0\">(</span><a href=\"http://www.google.com/search?hl=en&amp;q=allinurl%3Astring+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky\"><span class=\"kw3\">String</span></a> host, <span class=\"kw4\">int</span> port, <a href=\"http://www.google.com/search?hl=en&amp;q=allinurl%3Astring+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky\"><span class=\"kw3\">String</span></a> db, <a href=\"http://www.google.com/search?hl=en&amp;q=allinurl%3Astring+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky\"><span class=\"kw3\">String</span></a> user, <a href=\"http://www.google.com/search?hl=en&amp;q=allinurl%3Astring+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky\"><span class=\"kw3\">String</span></a> password<span class=\"br0\">)</span><br/>      <span class=\"kw1\">throws</span> <a href=\"http://www.google.com/search?hl=en&amp;q=allinurl%3Aclassnotfoundexception+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky\"><span class=\"kw3\">ClassNotFoundException</span></a>, <a href=\"http://www.google.com/search?hl=en&amp;q=allinurl%3Asqlexception+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky\"><span class=\"kw3\">SQLException</span></a> <span class=\"br0\">{</span><br/>\u00a0<br/>        <span class=\"kw1\">Class</span>.<span class=\"me1\">forName</span><span class=\"br0\">(</span><span class=\"st0\">\"com.mysql.jdbc.Driver\"</span><span class=\"br0\">)</span><span class=\"sy0\">;</span><br/>\u00a0<br/>        <span class=\"kw1\">this</span>.<span class=\"me1\">dbConnection</span> <span class=\"sy0\">=</span>  <a href=\"http://www.google.com/search?hl=en&amp;q=allinurl%3Adrivermanager+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky\"><span class=\"kw3\">DriverManager</span></a>.<span class=\"me1\">getConnection</span><span class=\"br0\">(</span><span class=\"st0\">\"jdbc:mysql://\"</span><br/>                                <span class=\"sy0\">+</span> host<br/>                                <span class=\"sy0\">+</span> <span class=\"st0\">\":\"</span><br/>                                <span class=\"sy0\">+</span> port<br/>                                <span class=\"sy0\">+</span> <span class=\"st0\">\"/\"</span><br/>                                <span class=\"sy0\">+</span> db, user, password<span class=\"br0\">)</span><span class=\"sy0\">;</span><br/>    <span class=\"br0\">}</span><br/>\u00a0<br/>    <span class=\"kw1\">public</span> <span class=\"kw4\">boolean</span> createUser<span class=\"br0\">(</span><a href=\"http://www.google.com/search?hl=en&amp;q=allinurl%3Astring+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky\"><span class=\"kw3\">String</span></a> user, <a href=\"http://www.google.com/search?hl=en&amp;q=allinurl%3Astring+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky\"><span class=\"kw3\">String</span></a> password<span class=\"br0\">)</span> <span class=\"br0\">{</span><br/>        <a href=\"http://www.google.com/search?hl=en&amp;q=allinurl%3Asecurerandom+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky\"><span class=\"kw3\">SecureRandom</span></a> random<span class=\"sy0\">;</span><br/>        <a href=\"http://www.google.com/search?hl=en&amp;q=allinurl%3Astring+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky\"><span class=\"kw3\">String</span></a> insert<span class=\"sy0\">;</span><br/>        <a href=\"http://www.google.com/search?hl=en&amp;q=allinurl%3Astring+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky\"><span class=\"kw3\">String</span></a> salt<span class=\"sy0\">;</span><br/>\u00a0<br/>        random <span class=\"sy0\">=</span> <span class=\"kw1\">new</span> <a href=\"http://www.google.com/search?hl=en&amp;q=allinurl%3Asecurerandom+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky\"><span class=\"kw3\">SecureRandom</span></a><span class=\"br0\">(</span><span class=\"br0\">)</span><span class=\"sy0\">;</span><br/>        salt <span class=\"sy0\">=</span>  <span class=\"kw1\">new</span> <a href=\"http://www.google.com/search?hl=en&amp;q=allinurl%3Abiginteger+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky\"><span class=\"kw3\">BigInteger</span></a><span class=\"br0\">(</span><span class=\"nu0\">130</span>, random<span class=\"br0\">)</span>.<span class=\"me1\">toString</span><span class=\"br0\">(</span><span class=\"nu0\">16</span><span class=\"br0\">)</span><span class=\"sy0\">;</span><br/>\u00a0<br/>        insert <span class=\"sy0\">=</span> <span class=\"st0\">\"INSERT INTO users \"</span><br/>            <span class=\"sy0\">+</span> <span class=\"st0\">\"(username, pass_salt, pass_md5) \"</span><br/>            <span class=\"sy0\">+</span> <span class=\"st0\">\"VALUES (?,\u00a0?,\u00a0?)\"</span><span class=\"sy0\">;</span><br/>\u00a0<br/>        <span class=\"kw1\">try</span> <span class=\"br0\">(</span><a href=\"http://www.google.com/search?hl=en&amp;q=allinurl%3Apreparedstatement+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky\"><span class=\"kw3\">PreparedStatement</span></a> pstmt <span class=\"sy0\">=</span> <span class=\"kw1\">this</span>.<span class=\"me1\">dbConnection</span>.<span class=\"me1\">prepareStatement</span><span class=\"br0\">(</span>insert<span class=\"br0\">)</span><span class=\"br0\">)</span> <span class=\"br0\">{</span><br/>            pstmt.<span class=\"me1\">setString</span><span class=\"br0\">(</span><span class=\"nu0\">1</span>, user<span class=\"br0\">)</span><span class=\"sy0\">;</span><br/>            pstmt.<span class=\"me1\">setString</span><span class=\"br0\">(</span><span class=\"nu0\">2</span>, salt<span class=\"br0\">)</span><span class=\"sy0\">;</span><br/>            pstmt.<span class=\"me1\">setString</span><span class=\"br0\">(</span><span class=\"nu0\">3</span>, <span class=\"kw1\">this</span>.<span class=\"me1\">md5</span><span class=\"br0\">(</span>salt <span class=\"sy0\">+</span> password<span class=\"br0\">)</span><span class=\"br0\">)</span><span class=\"sy0\">;</span><br/>            pstmt.<span class=\"me1\">executeUpdate</span><span class=\"br0\">(</span><span class=\"br0\">)</span><span class=\"sy0\">;</span><br/>\u00a0<br/>            <span class=\"kw1\">return</span> <span class=\"kw2\">true</span><span class=\"sy0\">;</span><br/>        <span class=\"br0\">}</span> <span class=\"kw1\">catch</span><span class=\"br0\">(</span><a href=\"http://www.google.com/search?hl=en&amp;q=allinurl%3Anosuchalgorithmexception+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky\"><span class=\"kw3\">NoSuchAlgorithmException</span></a> <span class=\"sy0\">|</span> <a href=\"http://www.google.com/search?hl=en&amp;q=allinurl%3Asqlexception+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky\"><span class=\"kw3\">SQLException</span></a> <span class=\"sy0\">|</span> <a href=\"http://www.google.com/search?hl=en&amp;q=allinurl%3Aunsupportedencodingexception+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky\"><span class=\"kw3\">UnsupportedEncodingException</span></a> ex<span class=\"br0\">)</span> <span class=\"br0\">{</span><br/>            <span class=\"kw1\">return</span> <span class=\"kw2\">false</span><span class=\"sy0\">;</span><br/>        <span class=\"br0\">}</span><br/>    <span class=\"br0\">}</span><br/>\u00a0<br/>    <span class=\"kw1\">public</span> <span class=\"kw4\">boolean</span> authenticateUser<span class=\"br0\">(</span><a href=\"http://www.google.com/search?hl=en&amp;q=allinurl%3Astring+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky\"><span class=\"kw3\">String</span></a> user, <a href=\"http://www.google.com/search?hl=en&amp;q=allinurl%3Astring+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky\"><span class=\"kw3\">String</span></a> password<span class=\"br0\">)</span> <span class=\"br0\">{</span><br/>        <a href=\"http://www.google.com/search?hl=en&amp;q=allinurl%3Astring+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky\"><span class=\"kw3\">String</span></a> pass_md5<span class=\"sy0\">;</span><br/>        <a href=\"http://www.google.com/search?hl=en&amp;q=allinurl%3Astring+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky\"><span class=\"kw3\">String</span></a> pass_salt<span class=\"sy0\">;</span><br/>        <a href=\"http://www.google.com/search?hl=en&amp;q=allinurl%3Astring+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky\"><span class=\"kw3\">String</span></a> select<span class=\"sy0\">;</span><br/>        <a href=\"http://www.google.com/search?hl=en&amp;q=allinurl%3Aresultset+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky\"><span class=\"kw3\">ResultSet</span></a> res<span class=\"sy0\">;</span><br/>\u00a0<br/>        select <span class=\"sy0\">=</span> <span class=\"st0\">\"SELECT pass_salt, pass_md5 FROM users WHERE username =\u00a0?\"</span><span class=\"sy0\">;</span><br/>        res <span class=\"sy0\">=</span> <span class=\"kw2\">null</span><span class=\"sy0\">;</span><br/>\u00a0<br/>        <span class=\"kw1\">try</span><span class=\"br0\">(</span><a href=\"http://www.google.com/search?hl=en&amp;q=allinurl%3Apreparedstatement+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky\"><span class=\"kw3\">PreparedStatement</span></a> pstmt <span class=\"sy0\">=</span> <span class=\"kw1\">this</span>.<span class=\"me1\">dbConnection</span>.<span class=\"me1\">prepareStatement</span><span class=\"br0\">(</span>select<span class=\"br0\">)</span><span class=\"br0\">)</span> <span class=\"br0\">{</span><br/>            pstmt.<span class=\"me1\">setString</span><span class=\"br0\">(</span><span class=\"nu0\">1</span>, user<span class=\"br0\">)</span><span class=\"sy0\">;</span><br/>            res <span class=\"sy0\">=</span> pstmt.<span class=\"me1\">executeQuery</span><span class=\"br0\">(</span><span class=\"br0\">)</span><span class=\"sy0\">;</span><br/>\u00a0<br/>            res.<span class=\"me1\">next</span><span class=\"br0\">(</span><span class=\"br0\">)</span><span class=\"sy0\">;</span> <span class=\"co1\">// We assume that username is unique</span><br/>\u00a0<br/>            pass_salt <span class=\"sy0\">=</span> res.<span class=\"me1\">getString</span><span class=\"br0\">(</span><span class=\"nu0\">1</span><span class=\"br0\">)</span><span class=\"sy0\">;</span><br/>            pass_md5 <span class=\"sy0\">=</span> res.<span class=\"me1\">getString</span><span class=\"br0\">(</span><span class=\"nu0\">2</span><span class=\"br0\">)</span><span class=\"sy0\">;</span><br/>\u00a0<br/>            <span class=\"kw1\">if</span> <span class=\"br0\">(</span>pass_md5.<span class=\"me1\">equals</span><span class=\"br0\">(</span><span class=\"kw1\">this</span>.<span class=\"me1\">md5</span><span class=\"br0\">(</span>pass_salt <span class=\"sy0\">+</span> password<span class=\"br0\">)</span><span class=\"br0\">)</span><span class=\"br0\">)</span> <span class=\"br0\">{</span><br/>                <span class=\"kw1\">return</span> <span class=\"kw2\">true</span><span class=\"sy0\">;</span><br/>            <span class=\"br0\">}</span> <span class=\"kw1\">else</span> <span class=\"br0\">{</span><br/>                <span class=\"kw1\">return</span> <span class=\"kw2\">false</span><span class=\"sy0\">;</span><br/>            <span class=\"br0\">}</span><br/>\u00a0<br/>        <span class=\"br0\">}</span> <span class=\"kw1\">catch</span><span class=\"br0\">(</span><a href=\"http://www.google.com/search?hl=en&amp;q=allinurl%3Anosuchalgorithmexception+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky\"><span class=\"kw3\">NoSuchAlgorithmException</span></a> <span class=\"sy0\">|</span> <a href=\"http://www.google.com/search?hl=en&amp;q=allinurl%3Asqlexception+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky\"><span class=\"kw3\">SQLException</span></a> <span class=\"sy0\">|</span> <a href=\"http://www.google.com/search?hl=en&amp;q=allinurl%3Aunsupportedencodingexception+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky\"><span class=\"kw3\">UnsupportedEncodingException</span></a> ex<span class=\"br0\">)</span> <span class=\"br0\">{</span><br/>            <span class=\"kw1\">return</span> <span class=\"kw2\">false</span><span class=\"sy0\">;</span><br/>        <span class=\"br0\">}</span> <span class=\"kw1\">finally</span> <span class=\"br0\">{</span><br/>            <span class=\"kw1\">try</span> <span class=\"br0\">{</span><br/>                <span class=\"kw1\">if</span> <span class=\"br0\">(</span>res <span class=\"kw1\">instanceof</span> <a href=\"http://www.google.com/search?hl=en&amp;q=allinurl%3Aresultset+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky\"><span class=\"kw3\">ResultSet</span></a> <span class=\"sy0\">&amp;&amp;</span> <span class=\"sy0\">!</span>res.<span class=\"me1\">isClosed</span><span class=\"br0\">(</span><span class=\"br0\">)</span><span class=\"br0\">)</span> <span class=\"br0\">{</span><br/>                    res.<span class=\"me1\">close</span><span class=\"br0\">(</span><span class=\"br0\">)</span><span class=\"sy0\">;</span><br/>                <span class=\"br0\">}</span><br/>            <span class=\"br0\">}</span> <span class=\"kw1\">catch</span><span class=\"br0\">(</span><a href=\"http://www.google.com/search?hl=en&amp;q=allinurl%3Asqlexception+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky\"><span class=\"kw3\">SQLException</span></a> ex<span class=\"br0\">)</span> <span class=\"br0\">{</span><br/>            <span class=\"br0\">}</span><br/>        <span class=\"br0\">}</span><br/>    <span class=\"br0\">}</span><br/>\u00a0<br/>    <span class=\"kw1\">public</span> <span class=\"kw4\">void</span> closeConnection<span class=\"br0\">(</span><span class=\"br0\">)</span> <span class=\"br0\">{</span><br/>        <span class=\"kw1\">try</span> <span class=\"br0\">{</span><br/>            <span class=\"kw1\">this</span>.<span class=\"me1\">dbConnection</span>.<span class=\"me1\">close</span><span class=\"br0\">(</span><span class=\"br0\">)</span><span class=\"sy0\">;</span><br/>        <span class=\"br0\">}</span> <span class=\"kw1\">catch</span><span class=\"br0\">(</span><a href=\"http://www.google.com/search?hl=en&amp;q=allinurl%3Anullpointerexception+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky\"><span class=\"kw3\">NullPointerException</span></a> <span class=\"sy0\">|</span> <a href=\"http://www.google.com/search?hl=en&amp;q=allinurl%3Asqlexception+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky\"><span class=\"kw3\">SQLException</span></a> ex<span class=\"br0\">)</span> <span class=\"br0\">{</span><br/>        <span class=\"br0\">}</span><br/>    <span class=\"br0\">}</span><br/>\u00a0<br/>    <span class=\"kw1\">public</span> <span class=\"kw1\">static</span> <span class=\"kw4\">void</span> main<span class=\"br0\">(</span><a href=\"http://www.google.com/search?hl=en&amp;q=allinurl%3Astring+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky\"><span class=\"kw3\">String</span></a><span class=\"br0\">[</span><span class=\"br0\">]</span> args<span class=\"br0\">)</span> <span class=\"br0\">{</span><br/>        UserManager um<span class=\"sy0\">;</span><br/>\u00a0<br/>        um <span class=\"sy0\">=</span> <span class=\"kw1\">new</span> UserManager<span class=\"br0\">(</span><span class=\"br0\">)</span><span class=\"sy0\">;</span><br/>        <span class=\"kw1\">try</span> <span class=\"br0\">{</span><br/>            um.<span class=\"me1\">connectDB</span><span class=\"br0\">(</span><span class=\"st0\">\"localhost\"</span>, <span class=\"nu0\">3306</span>, <span class=\"st0\">\"test\"</span>, <span class=\"st0\">\"root\"</span>, <span class=\"st0\">\"admin\"</span><span class=\"br0\">)</span><span class=\"sy0\">;</span><br/>\u00a0<br/>            <span class=\"kw1\">if</span> <span class=\"br0\">(</span>um.<span class=\"me1\">createUser</span><span class=\"br0\">(</span><span class=\"st0\">\"johndoe\"</span>, <span class=\"st0\">\"test\"</span><span class=\"br0\">)</span><span class=\"br0\">)</span> <span class=\"br0\">{</span><br/>                <a href=\"http://www.google.com/search?hl=en&amp;q=allinurl%3Asystem+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky\"><span class=\"kw3\">System</span></a>.<span class=\"me1\">out</span>.<span class=\"me1\">println</span><span class=\"br0\">(</span><span class=\"st0\">\"User created\"</span><span class=\"br0\">)</span><span class=\"sy0\">;</span><br/>            <span class=\"br0\">}</span><br/>\u00a0<br/>            <span class=\"kw1\">if</span> <span class=\"br0\">(</span>um.<span class=\"me1\">authenticateUser</span><span class=\"br0\">(</span><span class=\"st0\">\"johndoe\"</span>, <span class=\"st0\">\"test\"</span><span class=\"br0\">)</span><span class=\"br0\">)</span> <span class=\"br0\">{</span><br/>                <a href=\"http://www.google.com/search?hl=en&amp;q=allinurl%3Asystem+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky\"><span class=\"kw3\">System</span></a>.<span class=\"me1\">out</span>.<span class=\"me1\">println</span><span class=\"br0\">(</span><span class=\"st0\">\"User authenticated\"</span><span class=\"br0\">)</span><span class=\"sy0\">;</span><br/>            <span class=\"br0\">}</span><br/>        <span class=\"br0\">}</span> <span class=\"kw1\">catch</span><span class=\"br0\">(</span><a href=\"http://www.google.com/search?hl=en&amp;q=allinurl%3Aclassnotfoundexception+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky\"><span class=\"kw3\">ClassNotFoundException</span></a> <span class=\"sy0\">|</span> <a href=\"http://www.google.com/search?hl=en&amp;q=allinurl%3Asqlexception+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky\"><span class=\"kw3\">SQLException</span></a> ex<span class=\"br0\">)</span> <span class=\"br0\">{</span><br/>            ex.<span class=\"me1\">printStackTrace</span><span class=\"br0\">(</span><span class=\"br0\">)</span><span class=\"sy0\">;</span><br/>        <span class=\"br0\">}</span> <span class=\"kw1\">finally</span> <span class=\"br0\">{</span><br/>            um.<span class=\"me1\">closeConnection</span><span class=\"br0\">(</span><span class=\"br0\">)</span><span class=\"sy0\">;</span><br/>        <span class=\"br0\">}</span><br/>    <span class=\"br0\">}</span><br/><span class=\"br0\">}</span></pre>"}, {"lang": "Julia", "loc": 50, "block": "<pre class=\"text highlighted_source\">\u00a0<br/>using MySQL<br/>using Nettle  # for md5<br/>\u00a0<br/>function connect_db(uri, user, pw, dbname)<br/>    mydb = mysql_connect(uri, user, pw, dbname)<br/>\u00a0<br/>    const command = \"\"\"CREATE TABLE IF NOT EXISTS users (<br/>                          userid INT PRIMARY KEY AUTO_INCREMENT,<br/>                          username VARCHAR(32) UNIQUE KEY NOT NULL,<br/>                          pass_salt tinyblob NOT NULL,<br/>                              -- a string of 16 random bytes<br/>                          pass_md5 tinyblob NOT NULL<br/>                              -- binary MD5 hash of pass_salt concatenated with the password<br/>                  );\"\"\"<br/>    mysql_execute(mydb, command)<br/>    mydb<br/>end<br/>\u00a0<br/>function create_user(dbh, user, pw)<br/>    mysql_stmt_prepare(dbh, \"INSERT IGNORE INTO users (username, pass_salt, pass_md5) values (?,\u00a0?,\u00a0?);\")<br/>    salt = join([Char(c) for c in rand(UInt8, 16)], \"\")<br/>    passmd5 = digest(\"md5\", salt * user)<br/>    mysql_execute(dbh, [MYSQL_TYPE_VARCHAR, MYSQL_TYPE_VARCHAR, MYSQL_TYPE_VARCHAR], [user, salt, passmd5])<br/>end<br/>\u00a0<br/>function addusers(dbh, userdict)<br/>    for user in keys(userdict)<br/>        create_user(dbh, user, userdict[user])<br/>    end<br/>end<br/>\u00a0<br/>\"\"\"<br/>    authenticate_user<br/>Note this returns true if password provided authenticates as correct, false otherwise<br/>\"\"\"<br/>function authenticate_user(dbh, username, pw)<br/>    mysql_stmt_prepare(dbh, \"SELECT pass_salt, pass_md5 FROM users WHERE username =\u00a0?;\")<br/>    pass_salt, pass_md5 = mysql_execute(dbh, [MYSQL_TYPE_VARCHAR], [username], opformat=MYSQL_TUPLES)[1]   <br/>    pass_md5 == digest(\"md5\", pass_salt * username)<br/>end<br/>\u00a0<br/>const users = Dict(\"Joan\" =&gt; \"joanspw\", \"John\" =&gt; \"johnspw\", \"Mary\" =&gt; \"marpw\", \"Mark\" =&gt; \"markpw\")<br/>const mydb = connect_db(\"192.168.1.1\", \"julia\", \"julia\", \"mydb\")<br/>\u00a0<br/>addusers(mydb, users)<br/>println(\"\"\"John authenticates correctly: $(authenticate_user(mydb, \"John\", \"johnspw\")==false)\"\"\")<br/>println(\"\"\"Mary does not authenticate with password of 123: $(authenticate_user(mydb, \"Mary\", \"123\")==false)\"\"\")<br/>mysql_disconnect(mydb)<br/>\u00a0</pre>"}, {"lang": "Kotlin", "loc": 101, "block": "<pre class=\"scala highlighted_source\"><span class=\"co1\">// Version 1.2.41</span><br/>\u00a0<br/><a href=\"http://scala-lang.org\"><span class=\"kw1\">import</span></a> java.<span class=\"me1\">sql</span>.<span class=\"me1\">Connection</span><br/><a href=\"http://scala-lang.org\"><span class=\"kw1\">import</span></a> java.<span class=\"me1\">sql</span>.<span class=\"me1\">DriverManager</span><br/><a href=\"http://scala-lang.org\"><span class=\"kw1\">import</span></a> java.<span class=\"me1\">sql</span>.<span class=\"me1\">ResultSet</span><br/><a href=\"http://scala-lang.org\"><span class=\"kw1\">import</span></a> java.<span class=\"me1\">security</span>.<span class=\"me1\">MessageDigest</span><br/><a href=\"http://scala-lang.org\"><span class=\"kw1\">import</span></a> java.<span class=\"me1\">security</span>.<span class=\"me1\">SecureRandom</span><br/><a href=\"http://scala-lang.org\"><span class=\"kw1\">import</span></a> java.<span class=\"me1\">math</span>.<span class=\"me1\">BigInteger</span><br/>\u00a0<br/><a href=\"http://scala-lang.org\"><span class=\"kw1\">class</span></a> UserManager <span class=\"br0\">{</span><br/>    <a href=\"http://scala-lang.org\"><span class=\"kw1\">private</span></a> lateinit <a href=\"http://scala-lang.org\"><span class=\"kw1\">var</span></a> dbConnection<span class=\"sy0\">:</span> Connection<br/>\u00a0<br/>    <a href=\"http://scala-lang.org\"><span class=\"kw1\">private</span></a> fun md5<span class=\"br0\">(</span>message<span class=\"sy0\">:</span> String<span class=\"br0\">)</span><span class=\"sy0\">:</span> String <span class=\"br0\">{</span><br/>        <a href=\"http://scala-lang.org\"><span class=\"kw1\">val</span></a> hexString <span class=\"sy0\">=</span> StringBuilder<span class=\"br0\">(</span><span class=\"br0\">)</span><br/>        <a href=\"http://scala-lang.org\"><span class=\"kw1\">val</span></a> bytes <span class=\"sy0\">=</span> message.<span class=\"me1\">toByteArray</span><span class=\"br0\">(</span><span class=\"br0\">)</span><br/>        <a href=\"http://scala-lang.org\"><span class=\"kw1\">val</span></a> md <span class=\"sy0\">=</span> MessageDigest.<span class=\"me1\">getInstance</span><span class=\"br0\">(</span><span class=\"st0\">\"MD5\"</span><span class=\"br0\">)</span><br/>        <a href=\"http://scala-lang.org\"><span class=\"kw1\">val</span></a> dig <span class=\"sy0\">=</span> md.<span class=\"me1\">digest</span><span class=\"br0\">(</span>bytes<span class=\"br0\">)</span><br/>        <a href=\"http://scala-lang.org\"><span class=\"kw1\">for</span></a> <span class=\"br0\">(</span>i in <span class=\"nu0\">0</span> until dig.<span class=\"me1\">size</span><span class=\"br0\">)</span> <span class=\"br0\">{</span><br/>            <a href=\"http://scala-lang.org\"><span class=\"kw1\">val</span></a> hex <span class=\"sy0\">=</span> <span class=\"br0\">(</span>0xff and dig<span class=\"br0\">[</span>i<span class=\"br0\">]</span>.<span class=\"me1\">toInt</span><span class=\"br0\">(</span><span class=\"br0\">)</span><span class=\"br0\">)</span>.<span class=\"me1\">toString</span><span class=\"br0\">(</span><span class=\"nu0\">16</span><span class=\"br0\">)</span><br/>            <a href=\"http://scala-lang.org\"><span class=\"kw1\">if</span></a> <span class=\"br0\">(</span>hex.<span class=\"me1\">length</span> <span class=\"sy0\">==</span> <span class=\"nu0\">1</span><span class=\"br0\">)</span> hexString.<span class=\"me1\">append</span><span class=\"br0\">(</span><span class=\"st0\">'0'</span><span class=\"br0\">)</span><br/>            hexString.<span class=\"me1\">append</span><span class=\"br0\">(</span>hex<span class=\"br0\">)</span><br/>        <span class=\"br0\">}</span><br/>        <a href=\"http://scala-lang.org\"><span class=\"kw1\">return</span></a> hexString.<span class=\"me1\">toString</span><span class=\"br0\">(</span><span class=\"br0\">)</span><br/>    <span class=\"br0\">}</span><br/>\u00a0<br/>    fun connectDB<span class=\"br0\">(</span>host<span class=\"sy0\">:</span> String, port<span class=\"sy0\">:</span> Int, db<span class=\"sy0\">:</span> String, user<span class=\"sy0\">:</span> String, pwd<span class=\"sy0\">:</span> String<span class=\"br0\">)</span> <span class=\"br0\">{</span><br/>        Class.<span class=\"me1\">forName</span><span class=\"br0\">(</span><span class=\"st0\">\"com.mysql.jdbc.Driver\"</span><span class=\"br0\">)</span><br/>        dbConnection <span class=\"sy0\">=</span> DriverManager.<span class=\"me1\">getConnection</span><span class=\"br0\">(</span><br/>            <span class=\"st0\">\"jdbc:mysql://$host:$port/$db\"</span>, user, pwd<br/>        <span class=\"br0\">)</span><br/>    <span class=\"br0\">}</span><br/>\u00a0<br/>    fun createUser<span class=\"br0\">(</span>user<span class=\"sy0\">:</span> String, pwd<span class=\"sy0\">:</span> String<span class=\"br0\">)</span><span class=\"sy0\">:</span> Boolean <span class=\"br0\">{</span><br/>        <a href=\"http://scala-lang.org\"><span class=\"kw1\">val</span></a> random <span class=\"sy0\">=</span> SecureRandom<span class=\"br0\">(</span><span class=\"br0\">)</span><br/>        <a href=\"http://scala-lang.org\"><span class=\"kw1\">val</span></a> salt <span class=\"sy0\">=</span> BigInteger<span class=\"br0\">(</span><span class=\"nu0\">130</span>, random<span class=\"br0\">)</span>.<span class=\"me1\">toString</span><span class=\"br0\">(</span><span class=\"nu0\">16</span><span class=\"br0\">)</span><br/>        <a href=\"http://scala-lang.org\"><span class=\"kw1\">val</span></a> insert <span class=\"sy0\">=</span> <span class=\"st0\">\"INSERT INTO users \"</span> +<br/>            <span class=\"st0\">\"(username, pass_salt, pass_md5) \"</span> +<br/>            <span class=\"st0\">\"VALUES (?,\u00a0?,\u00a0?)\"</span><br/>        <a href=\"http://scala-lang.org\"><span class=\"kw1\">try</span></a> <span class=\"br0\">{</span><br/>            <a href=\"http://scala-lang.org\"><span class=\"kw1\">val</span></a> pstmt <span class=\"sy0\">=</span> dbConnection.<span class=\"me1\">prepareStatement</span><span class=\"br0\">(</span>insert<span class=\"br0\">)</span><br/>            <a href=\"http://scala-lang.org\"><span class=\"kw1\">with</span></a> <span class=\"br0\">(</span>pstmt<span class=\"br0\">)</span> <span class=\"br0\">{</span><br/>                setString<span class=\"br0\">(</span><span class=\"nu0\">1</span>, user<span class=\"br0\">)</span><br/>                setString<span class=\"br0\">(</span><span class=\"nu0\">2</span>, salt<span class=\"br0\">)</span><br/>                setString<span class=\"br0\">(</span><span class=\"nu0\">3</span>, md5<span class=\"br0\">(</span>salt + pwd<span class=\"br0\">)</span><span class=\"br0\">)</span><br/>                <a href=\"http://scala-lang.org\"><span class=\"kw1\">val</span></a> rowCount <span class=\"sy0\">=</span> executeUpdate<span class=\"br0\">(</span><span class=\"br0\">)</span><br/>                close<span class=\"br0\">(</span><span class=\"br0\">)</span><br/>                <a href=\"http://scala-lang.org\"><span class=\"kw1\">if</span></a> <span class=\"br0\">(</span>rowCount <span class=\"sy0\">==</span> <span class=\"nu0\">0</span><span class=\"br0\">)</span> <a href=\"http://scala-lang.org\"><span class=\"kw1\">return</span></a> <a href=\"http://scala-lang.org\"><span class=\"kw1\">false</span></a><br/>            <span class=\"br0\">}</span><br/>            <a href=\"http://scala-lang.org\"><span class=\"kw1\">return</span></a> <a href=\"http://scala-lang.org\"><span class=\"kw1\">true</span></a><br/>        <span class=\"br0\">}</span><br/>        <a href=\"http://scala-lang.org\"><span class=\"kw1\">catch</span></a> <span class=\"br0\">(</span>ex<span class=\"sy0\">:</span> Exception<span class=\"br0\">)</span> <span class=\"br0\">{</span><br/>            <a href=\"http://scala-lang.org\"><span class=\"kw1\">return</span></a> <a href=\"http://scala-lang.org\"><span class=\"kw1\">false</span></a><br/>        <span class=\"br0\">}</span><br/>    <span class=\"br0\">}</span><br/>\u00a0<br/>    fun authenticateUser<span class=\"br0\">(</span>user<span class=\"sy0\">:</span> String, pwd<span class=\"sy0\">:</span> String<span class=\"br0\">)</span><span class=\"sy0\">:</span> Boolean <span class=\"br0\">{</span><br/>        <a href=\"http://scala-lang.org\"><span class=\"kw1\">val</span></a> select <span class=\"sy0\">=</span> <span class=\"st0\">\"SELECT pass_salt, pass_md5 FROM users WHERE username =\u00a0?\"</span><br/>        lateinit <a href=\"http://scala-lang.org\"><span class=\"kw1\">var</span></a> res<span class=\"sy0\">:</span> ResultSet<br/>        <a href=\"http://scala-lang.org\"><span class=\"kw1\">try</span></a> <span class=\"br0\">{</span><br/>            <a href=\"http://scala-lang.org\"><span class=\"kw1\">val</span></a> pstmt <span class=\"sy0\">=</span> dbConnection.<span class=\"me1\">prepareStatement</span><span class=\"br0\">(</span>select<span class=\"br0\">)</span><br/>            <a href=\"http://scala-lang.org\"><span class=\"kw1\">with</span></a> <span class=\"br0\">(</span>pstmt<span class=\"br0\">)</span> <span class=\"br0\">{</span><br/>                setString<span class=\"br0\">(</span><span class=\"nu0\">1</span>, user<span class=\"br0\">)</span><br/>                res <span class=\"sy0\">=</span> executeQuery<span class=\"br0\">(</span><span class=\"br0\">)</span><br/>                res.<span class=\"me1\">next</span><span class=\"br0\">(</span><span class=\"br0\">)</span>  <span class=\"co1\">// assuming that username is unique</span><br/>                <a href=\"http://scala-lang.org\"><span class=\"kw1\">val</span></a> passSalt <span class=\"sy0\">=</span> res.<span class=\"me1\">getString</span><span class=\"br0\">(</span><span class=\"nu0\">1</span><span class=\"br0\">)</span><br/>                <a href=\"http://scala-lang.org\"><span class=\"kw1\">val</span></a> passMD5  <span class=\"sy0\">=</span> res.<span class=\"me1\">getString</span><span class=\"br0\">(</span><span class=\"nu0\">2</span><span class=\"br0\">)</span><br/>                close<span class=\"br0\">(</span><span class=\"br0\">)</span><br/>                <a href=\"http://scala-lang.org\"><span class=\"kw1\">return</span></a> passMD5 <span class=\"sy0\">==</span> md5<span class=\"br0\">(</span>passSalt + pwd<span class=\"br0\">)</span><br/>            <span class=\"br0\">}</span><br/>        <span class=\"br0\">}</span><br/>        <a href=\"http://scala-lang.org\"><span class=\"kw1\">catch</span></a> <span class=\"br0\">(</span>ex<span class=\"sy0\">:</span> Exception<span class=\"br0\">)</span> <span class=\"br0\">{</span><br/>            <a href=\"http://scala-lang.org\"><span class=\"kw1\">return</span></a> <a href=\"http://scala-lang.org\"><span class=\"kw1\">false</span></a><br/>        <span class=\"br0\">}</span><br/>        <a href=\"http://scala-lang.org\"><span class=\"kw1\">finally</span></a> <span class=\"br0\">{</span><br/>            <a href=\"http://scala-lang.org\"><span class=\"kw1\">if</span></a> <span class=\"br0\">(</span><span class=\"sy0\">!</span>res.<span class=\"me1\">isClosed</span><span class=\"br0\">)</span> res.<span class=\"me1\">close</span><span class=\"br0\">(</span><span class=\"br0\">)</span><br/>        <span class=\"br0\">}</span><br/>    <span class=\"br0\">}</span><br/>\u00a0<br/>    fun closeConnection<span class=\"br0\">(</span><span class=\"br0\">)</span> <span class=\"br0\">{</span><br/>        <a href=\"http://scala-lang.org\"><span class=\"kw1\">if</span></a> <span class=\"br0\">(</span><span class=\"sy0\">!</span>dbConnection.<span class=\"me1\">isClosed</span><span class=\"br0\">)</span> dbConnection.<span class=\"me1\">close</span><span class=\"br0\">(</span><span class=\"br0\">)</span><br/>    <span class=\"br0\">}</span><br/><span class=\"br0\">}</span><br/>\u00a0<br/>fun main<span class=\"br0\">(</span>args<span class=\"sy0\">:</span> Array<span class=\"sy0\">&lt;</span>String<span class=\"sy0\">&gt;</span><span class=\"br0\">)</span> <span class=\"br0\">{</span><br/>    <a href=\"http://scala-lang.org\"><span class=\"kw1\">val</span></a> um <span class=\"sy0\">=</span> UserManager<span class=\"br0\">(</span><span class=\"br0\">)</span><br/>    <a href=\"http://scala-lang.org\"><span class=\"kw1\">with</span></a> <span class=\"br0\">(</span>um<span class=\"br0\">)</span> <span class=\"br0\">{</span><br/>        <a href=\"http://scala-lang.org\"><span class=\"kw1\">try</span></a> <span class=\"br0\">{</span><br/>            connectDB<span class=\"br0\">(</span><span class=\"st0\">\"localhost\"</span>, <span class=\"nu0\">3306</span>, <span class=\"st0\">\"test\"</span>, <span class=\"st0\">\"root\"</span>, <span class=\"st0\">\"admin\"</span><span class=\"br0\">)</span><br/>            <a href=\"http://scala-lang.org\"><span class=\"kw1\">if</span></a> <span class=\"br0\">(</span>createUser<span class=\"br0\">(</span><span class=\"st0\">\"johndoe\"</span>, <span class=\"st0\">\"test\"</span><span class=\"br0\">)</span><span class=\"br0\">)</span> println<span class=\"br0\">(</span><span class=\"st0\">\"User created\"</span><span class=\"br0\">)</span><br/>            <a href=\"http://scala-lang.org\"><span class=\"kw1\">if</span></a> <span class=\"br0\">(</span>authenticateUser<span class=\"br0\">(</span><span class=\"st0\">\"johndoe\"</span>, <span class=\"st0\">\"test\"</span><span class=\"br0\">)</span><span class=\"br0\">)</span> <span class=\"br0\">{</span><br/>                println<span class=\"br0\">(</span><span class=\"st0\">\"User authenticated\"</span><span class=\"br0\">)</span><br/>            <span class=\"br0\">}</span><br/>        <span class=\"br0\">}</span><br/>        <a href=\"http://scala-lang.org\"><span class=\"kw1\">catch</span></a><span class=\"br0\">(</span>ex<span class=\"sy0\">:</span> Exception<span class=\"br0\">)</span> <span class=\"br0\">{</span><br/>            ex.<span class=\"me1\">printStackTrace</span><span class=\"br0\">(</span><span class=\"br0\">)</span><br/>        <span class=\"br0\">}</span><br/>        <a href=\"http://scala-lang.org\"><span class=\"kw1\">finally</span></a> <span class=\"br0\">{</span><br/>            closeConnection<span class=\"br0\">(</span><span class=\"br0\">)</span><br/>        <span class=\"br0\">}</span><br/>    <span class=\"br0\">}</span><br/><span class=\"br0\">}</span></pre>"}, {"lang": "Mathematica", "loc": 24, "block": "<pre class=\"text highlighted_source\">Needs[\"DatabaseLink`\"];<br/>connectDb[dbUser_, dbPass_, dbUrl_]\u00a0:= <br/>  OpenSQLConnection[JDBC[\"mysql\", dbUrl], \"Username\" -&gt; dbUser, <br/>   \"Password\" -&gt; dbPass];<br/>createUser::nameTaken = \"The username '`1`' is already taken.\";<br/>createUser[dbUser_, dbPass_, dbUrl_, user_, pass_]\u00a0:= <br/>  Module[{db = connectDb[dbUser, dbPass, dbUrl], <br/>    salt = RandomChoice[Range[32, 127], 16]}, <br/>   If[MemberQ[SQLSelect[db, \"users\", {\"username\"}], {user}], <br/>    Message[createUser::nameTaken, user]; Return[]]; <br/>   SQLInsert[db, <br/>    \"users\", {\"username\", \"pass_salt\", \"pass_md5\"}, {user, <br/>     SQLBinary[salt], <br/>     SQLBinary[<br/>      IntegerDigits[Hash[FromCharacterCode[salt] &lt;&gt; pass, \"MD5\"], 256,<br/>        16]]}]; CloseSQLConnection[db];];<br/>authenticateUser[dbUser_, dbPass_, dbUrl_, user_, pass_]\u00a0:= <br/>  Module[{db = connectDb[dbUser, dbPass, dbUrl], rtn}, <br/>   rtn = MemberQ[SQLSelect[db, \"users\", {\"username\"}], {user}] &amp;&amp; <br/>     Module[{data = <br/>        SQLSelect[db, \"users\", {\"username\", \"pass_salt\", \"pass_md5\"}, <br/>          SQLColumn[\"username\"] == user][[1]]}, <br/>      Hash[FromCharacterCode[data[[2, 1]]] &lt;&gt; pass, \"MD5\"] == <br/>       FromDigits[data[[3, 1]], 256]]; CloseSQLConnection[db]; rtn];</pre>"}, {"lang": "Objeck", "loc": 104, "block": "<pre class=\"objeck highlighted_source\"><span class=\"kw1\">use</span> ODBC<span class=\"sy0\">;</span><br/><span class=\"kw1\">use</span> Encryption<span class=\"sy0\">;</span><br/>\u00a0<br/><span class=\"kw1\">class</span> SqlTest <span class=\"br0\">{</span><br/>  @conn <span class=\"sy0\">:</span> Connection<span class=\"sy0\">;</span><br/>\u00a0<br/>  <span class=\"kw1\">function</span> <span class=\"sy0\">:</span> Main<span class=\"br0\">(</span>args <span class=\"sy0\">:</span> <span class=\"kw2\">String</span><span class=\"br0\">[</span><span class=\"br0\">]</span><span class=\"br0\">)</span> ~ <span class=\"kw2\">Nil</span> <span class=\"br0\">{</span><br/>    SqlTest<span class=\"sy0\">-&gt;</span><span class=\"me1\">New</span><span class=\"br0\">(</span><span class=\"br0\">)</span><span class=\"sy0\">-&gt;</span><span class=\"me1\">Run</span><span class=\"br0\">(</span><span class=\"br0\">)</span><span class=\"sy0\">;</span><br/>  <span class=\"br0\">}</span><br/>\u00a0<br/>  New<span class=\"br0\">(</span><span class=\"br0\">)</span> <span class=\"br0\">{</span>  <br/>    @conn <span class=\"sy0\">:=</span> Connection<span class=\"sy0\">-&gt;</span><span class=\"me1\">New</span><span class=\"br0\">(</span><span class=\"st0\">\"test\"</span><span class=\"sy0\">,</span> <span class=\"st0\">\"root\"</span><span class=\"sy0\">,</span> <span class=\"st0\">\"helloworld\"</span><span class=\"br0\">)</span><span class=\"sy0\">;</span><br/>  <span class=\"br0\">}</span><br/>\u00a0<br/>  <span class=\"kw1\">method</span> <span class=\"sy0\">:</span> Run<span class=\"br0\">(</span><span class=\"br0\">)</span> ~ <span class=\"kw2\">Nil</span> <span class=\"br0\">{</span><br/>    CreateUser<span class=\"br0\">(</span><span class=\"st0\">\"objeck\"</span><span class=\"sy0\">,</span> <span class=\"st0\">\"beer\"</span><span class=\"br0\">)</span><span class=\"sy0\">;</span><br/>    AuthenticateUser<span class=\"br0\">(</span><span class=\"st0\">\"objeck\"</span><span class=\"sy0\">,</span> <span class=\"st0\">\"beer\"</span><span class=\"br0\">)</span><span class=\"sy0\">;</span><br/>    leaving <span class=\"br0\">{</span><br/>      @conn<span class=\"sy0\">-&gt;</span><span class=\"me1\">Close</span><span class=\"br0\">(</span><span class=\"br0\">)</span><span class=\"sy0\">;</span><br/>    <span class=\"br0\">}</span><span class=\"sy0\">;</span><br/>  <span class=\"br0\">}</span><br/>\u00a0<br/>  <span class=\"kw1\">method</span> <span class=\"sy0\">:</span> AuthenticateUser<span class=\"br0\">(</span>username <span class=\"sy0\">:</span> <span class=\"kw2\">String</span><span class=\"sy0\">,</span> password <span class=\"sy0\">:</span> <span class=\"kw2\">String</span><span class=\"br0\">)</span> ~ <span class=\"kw2\">Nil</span> <span class=\"br0\">{</span><br/>    status <span class=\"sy0\">:=</span> <span class=\"kw3\">false</span><span class=\"sy0\">;</span><br/>    ps <span class=\"sy0\">:</span> ParameterStatement<span class=\"sy0\">;</span><br/>    result <span class=\"sy0\">:</span> ResultSet<span class=\"sy0\">;</span><br/>    <span class=\"kw1\">if</span><span class=\"br0\">(</span>@conn<span class=\"sy0\">-&gt;</span><span class=\"me1\">IsOpen</span><span class=\"br0\">(</span><span class=\"br0\">)</span><span class=\"br0\">)</span> <span class=\"br0\">{</span><br/>      sql <span class=\"sy0\">:=</span> <span class=\"st0\">\"SELECT pass_salt, pass_md5 FROM users WHERE username =\u00a0?\"</span><span class=\"sy0\">;</span><br/>      ps <span class=\"sy0\">:=</span> @conn<span class=\"sy0\">-&gt;</span><span class=\"me1\">CreateParameterStatement</span><span class=\"br0\">(</span>sql<span class=\"br0\">)</span><span class=\"sy0\">;</span><br/>      ps<span class=\"sy0\">-&gt;</span><span class=\"me1\">SetVarchar</span><span class=\"br0\">(</span><span class=\"nu0\">1</span><span class=\"sy0\">,</span> username<span class=\"br0\">)</span><span class=\"sy0\">;</span><br/>\u00a0<br/>      result <span class=\"sy0\">:=</span> ps<span class=\"sy0\">-&gt;</span><span class=\"me1\">Select</span><span class=\"br0\">(</span><span class=\"br0\">)</span><span class=\"sy0\">;</span><br/>      <span class=\"kw1\">if</span><span class=\"br0\">(</span>result <span class=\"sy0\">&lt;&gt;</span> <span class=\"kw2\">Nil</span> <span class=\"sy0\">&amp;</span> result<span class=\"sy0\">-&gt;</span><span class=\"me1\">Next</span><span class=\"br0\">(</span><span class=\"br0\">)</span><span class=\"br0\">)</span> <span class=\"br0\">{</span><br/>        salt_buffer <span class=\"sy0\">:=</span> Byte<span class=\"sy0\">-&gt;</span><span class=\"me1\">New</span><span class=\"br0\">[</span><span class=\"nu0\">16</span><span class=\"br0\">]</span><span class=\"sy0\">;</span><br/>        result<span class=\"sy0\">-&gt;</span><span class=\"me1\">GetBlob</span><span class=\"br0\">(</span><span class=\"nu0\">1</span><span class=\"sy0\">,</span> salt_buffer<span class=\"br0\">)</span><span class=\"sy0\">;</span><br/>        salt <span class=\"sy0\">:=</span> <span class=\"st0\">\"\"</span><span class=\"sy0\">;</span><br/>        <span class=\"kw1\">for</span><span class=\"br0\">(</span>i <span class=\"sy0\">:=</span> <span class=\"nu0\">0</span><span class=\"sy0\">;</span> i <span class=\"sy0\">&lt;</span> <span class=\"nu0\">16</span><span class=\"sy0\">;</span> i<span class=\"sy0\">+=</span><span class=\"nu0\">1</span><span class=\"sy0\">;</span><span class=\"br0\">)</span> <span class=\"br0\">{</span><br/>          salt<span class=\"sy0\">-&gt;</span><span class=\"me1\">Append</span><span class=\"br0\">(</span>salt_buffer<span class=\"br0\">[</span>i<span class=\"br0\">]</span><span class=\"br0\">)</span><span class=\"sy0\">;</span><br/>        <span class=\"br0\">}</span><span class=\"sy0\">;</span><br/>\u00a0<br/>        db_password_buffer <span class=\"sy0\">:=</span> Byte<span class=\"sy0\">-&gt;</span><span class=\"me1\">New</span><span class=\"br0\">[</span><span class=\"nu0\">16</span><span class=\"br0\">]</span><span class=\"sy0\">;</span><br/>        result<span class=\"sy0\">-&gt;</span><span class=\"me1\">GetBlob</span><span class=\"br0\">(</span><span class=\"nu0\">2</span><span class=\"sy0\">,</span> db_password_buffer<span class=\"br0\">)</span><span class=\"sy0\">;</span><br/>\u00a0<br/>        password<span class=\"sy0\">-&gt;</span><span class=\"me1\">Append</span><span class=\"br0\">(</span>salt<span class=\"br0\">)</span><span class=\"sy0\">;</span><br/>        user_password_buffer <span class=\"sy0\">:=</span> Hash<span class=\"sy0\">-&gt;</span><span class=\"me1\">MD5</span><span class=\"br0\">(</span>password<span class=\"sy0\">-&gt;</span><span class=\"me1\">ToByteArray</span><span class=\"br0\">(</span><span class=\"br0\">)</span><span class=\"br0\">)</span><span class=\"sy0\">;</span><br/>\u00a0<br/>        IO.Console<span class=\"sy0\">-&gt;</span><span class=\"me1\">Print</span><span class=\"br0\">(</span><span class=\"st0\">\"user: authenticated=\"</span><span class=\"br0\">)</span><span class=\"sy0\">-&gt;</span><span class=\"me1\">PrintLine</span><span class=\"br0\">(</span>IsEqual<span class=\"br0\">(</span>db_password_buffer<span class=\"sy0\">,</span> user_password_buffer<span class=\"br0\">)</span><span class=\"br0\">)</span><span class=\"sy0\">;</span><br/>      <span class=\"br0\">}</span><span class=\"sy0\">;</span><br/>\u00a0<br/>    <span class=\"br0\">}</span><span class=\"sy0\">;</span><br/>\u00a0<br/>    leaving <span class=\"br0\">{</span><br/>      <span class=\"kw1\">if</span><span class=\"br0\">(</span>ps <span class=\"sy0\">&lt;&gt;</span> <span class=\"kw2\">Nil</span><span class=\"br0\">)</span> <span class=\"br0\">{</span><br/>        ps<span class=\"sy0\">-&gt;</span><span class=\"me1\">Close</span><span class=\"br0\">(</span><span class=\"br0\">)</span><span class=\"sy0\">;</span><br/>      <span class=\"br0\">}</span><span class=\"sy0\">;</span><br/>\u00a0<br/>      <span class=\"kw1\">if</span><span class=\"br0\">(</span>ps <span class=\"sy0\">&lt;&gt;</span> <span class=\"kw2\">Nil</span><span class=\"br0\">)</span> <span class=\"br0\">{</span><br/>        ps<span class=\"sy0\">-&gt;</span><span class=\"me1\">Close</span><span class=\"br0\">(</span><span class=\"br0\">)</span><span class=\"sy0\">;</span><br/>      <span class=\"br0\">}</span><span class=\"sy0\">;</span><br/>    <span class=\"br0\">}</span><span class=\"sy0\">;</span><br/>  <span class=\"br0\">}</span><br/>\u00a0<br/>  <span class=\"kw1\">method</span> <span class=\"sy0\">:</span> CreateUser<span class=\"br0\">(</span>username <span class=\"sy0\">:</span> <span class=\"kw2\">String</span><span class=\"sy0\">,</span> password <span class=\"sy0\">:</span> <span class=\"kw2\">String</span><span class=\"br0\">)</span> ~ <span class=\"kw2\">Nil</span> <span class=\"br0\">{</span><br/>    salt <span class=\"sy0\">:=</span> <span class=\"st0\">\"\"</span><span class=\"sy0\">;</span><br/>    <span class=\"kw1\">for</span><span class=\"br0\">(</span>i <span class=\"sy0\">:=</span> <span class=\"nu0\">0</span><span class=\"sy0\">;</span> i <span class=\"sy0\">&lt;</span> <span class=\"nu0\">16</span><span class=\"sy0\">;</span> i<span class=\"sy0\">+=</span><span class=\"nu0\">1</span><span class=\"sy0\">;</span><span class=\"br0\">)</span> <span class=\"br0\">{</span> salt<span class=\"sy0\">-&gt;</span><span class=\"me1\">Append</span><span class=\"br0\">(</span><span class=\"br0\">(</span>Float<span class=\"sy0\">-&gt;</span><span class=\"me1\">Random</span><span class=\"br0\">(</span><span class=\"br0\">)</span> <span class=\"sy0\">*</span> <span class=\"nu0\">100</span><span class=\"br0\">)</span><span class=\"sy0\">-&gt;</span><span class=\"me1\">As</span><span class=\"br0\">(</span><span class=\"kw2\">Int</span><span class=\"br0\">)</span><span class=\"br0\">)</span><span class=\"sy0\">;</span> <span class=\"br0\">}</span><span class=\"sy0\">;</span><br/>    salt <span class=\"sy0\">:=</span> salt<span class=\"sy0\">-&gt;</span><span class=\"me1\">SubString</span><span class=\"br0\">(</span><span class=\"nu0\">16</span><span class=\"br0\">)</span><span class=\"sy0\">;</span><br/>\u00a0<br/>    password<span class=\"sy0\">-&gt;</span><span class=\"me1\">Append</span><span class=\"br0\">(</span>salt<span class=\"br0\">)</span><span class=\"sy0\">;</span><br/>    md5_password <span class=\"sy0\">:=</span> Hash<span class=\"sy0\">-&gt;</span><span class=\"me1\">MD5</span><span class=\"br0\">(</span>password<span class=\"sy0\">-&gt;</span><span class=\"me1\">ToByteArray</span><span class=\"br0\">(</span><span class=\"br0\">)</span><span class=\"br0\">)</span><span class=\"sy0\">;</span><br/>\u00a0<br/>    ps <span class=\"sy0\">:</span> ParameterStatement<span class=\"sy0\">;</span><br/>    <span class=\"kw1\">if</span><span class=\"br0\">(</span>@conn<span class=\"sy0\">-&gt;</span><span class=\"me1\">IsOpen</span><span class=\"br0\">(</span><span class=\"br0\">)</span><span class=\"br0\">)</span> <span class=\"br0\">{</span><br/>      sql <span class=\"sy0\">:=</span> <span class=\"st0\">\"INSERT INTO users(username, pass_salt, pass_md5) VALUES (?,\u00a0?,\u00a0?)\"</span><span class=\"sy0\">;</span>      <br/>      ps <span class=\"sy0\">:=</span> @conn<span class=\"sy0\">-&gt;</span><span class=\"me1\">CreateParameterStatement</span><span class=\"br0\">(</span>sql<span class=\"br0\">)</span><span class=\"sy0\">;</span><br/>      ps<span class=\"sy0\">-&gt;</span><span class=\"me1\">SetVarchar</span><span class=\"br0\">(</span><span class=\"nu0\">1</span><span class=\"sy0\">,</span> username<span class=\"br0\">)</span><span class=\"sy0\">;</span><br/>      ps<span class=\"sy0\">-&gt;</span><span class=\"me1\">SetBytes</span><span class=\"br0\">(</span><span class=\"nu0\">2</span><span class=\"sy0\">,</span> salt<span class=\"sy0\">-&gt;</span><span class=\"me1\">ToByteArray</span><span class=\"br0\">(</span><span class=\"br0\">)</span><span class=\"br0\">)</span><span class=\"sy0\">;</span><br/>      ps<span class=\"sy0\">-&gt;</span><span class=\"me1\">SetBytes</span><span class=\"br0\">(</span><span class=\"nu0\">3</span><span class=\"sy0\">,</span> md5_password<span class=\"br0\">)</span><span class=\"sy0\">;</span><br/>\u00a0<br/>      IO.Console<span class=\"sy0\">-&gt;</span><span class=\"me1\">Print</span><span class=\"br0\">(</span><span class=\"st0\">\"adding user: username=\"</span><span class=\"br0\">)</span><span class=\"sy0\">-&gt;</span><span class=\"me1\">Print</span><span class=\"br0\">(</span>username<span class=\"br0\">)</span><br/>        <span class=\"sy0\">-&gt;</span><span class=\"me1\">Print</span><span class=\"br0\">(</span><span class=\"st0\">\", salt=\"</span><span class=\"br0\">)</span><span class=\"sy0\">-&gt;</span><span class=\"me1\">Print</span><span class=\"br0\">(</span>salt<span class=\"br0\">)</span><br/>        <span class=\"sy0\">-&gt;</span><span class=\"me1\">Print</span><span class=\"br0\">(</span><span class=\"st0\">\", status=\"</span><span class=\"br0\">)</span><span class=\"sy0\">-&gt;</span><span class=\"me1\">PrintLine</span><span class=\"br0\">(</span>ps<span class=\"sy0\">-&gt;</span><span class=\"me1\">Update</span><span class=\"br0\">(</span><span class=\"br0\">)</span><span class=\"br0\">)</span><span class=\"sy0\">;</span>      <br/>    <span class=\"br0\">}</span><span class=\"sy0\">;</span><br/>\u00a0<br/>    leaving <span class=\"br0\">{</span><br/>      <span class=\"kw1\">if</span><span class=\"br0\">(</span>ps <span class=\"sy0\">&lt;&gt;</span> <span class=\"kw2\">Nil</span><span class=\"br0\">)</span> <span class=\"br0\">{</span><br/>        ps<span class=\"sy0\">-&gt;</span><span class=\"me1\">Close</span><span class=\"br0\">(</span><span class=\"br0\">)</span><span class=\"sy0\">;</span><br/>      <span class=\"br0\">}</span><span class=\"sy0\">;</span><br/>    <span class=\"br0\">}</span><span class=\"sy0\">;</span><br/>  <span class=\"br0\">}</span><br/>\u00a0<br/>  <span class=\"kw1\">method</span> <span class=\"sy0\">:</span> IsEqual<span class=\"br0\">(</span>left <span class=\"sy0\">:</span> <span class=\"kw2\">Byte</span><span class=\"br0\">[</span><span class=\"br0\">]</span><span class=\"sy0\">,</span> right <span class=\"sy0\">:</span> <span class=\"kw2\">Byte</span><span class=\"br0\">[</span><span class=\"br0\">]</span><span class=\"br0\">)</span> ~ <span class=\"kw2\">Bool</span> <span class=\"br0\">{</span><br/>    <span class=\"kw1\">if</span><span class=\"br0\">(</span>left<span class=\"sy0\">-&gt;</span><span class=\"me1\">Size</span><span class=\"br0\">(</span><span class=\"br0\">)</span> <span class=\"sy0\">&lt;&gt;</span> right<span class=\"sy0\">-&gt;</span><span class=\"me1\">Size</span><span class=\"br0\">(</span><span class=\"br0\">)</span><span class=\"br0\">)</span> <span class=\"br0\">{</span><br/>      <span class=\"kw1\">return</span> <span class=\"kw3\">false</span><span class=\"sy0\">;</span><br/>    <span class=\"br0\">}</span><span class=\"sy0\">;</span><br/>\u00a0<br/>    <span class=\"kw1\">each</span><span class=\"br0\">(</span>i <span class=\"sy0\">:</span> left<span class=\"br0\">)</span> <span class=\"br0\">{</span>        <br/>      <span class=\"kw1\">if</span><span class=\"br0\">(</span>left<span class=\"br0\">[</span>i<span class=\"br0\">]</span> <span class=\"sy0\">&lt;&gt;</span> right<span class=\"br0\">[</span>i<span class=\"br0\">]</span><span class=\"br0\">)</span> <span class=\"br0\">{</span><br/>        <span class=\"kw1\">return</span> <span class=\"kw3\">false</span><span class=\"sy0\">;</span><br/>      <span class=\"br0\">}</span><span class=\"sy0\">;</span><br/>    <span class=\"br0\">}</span><span class=\"sy0\">;</span><br/>\u00a0<br/>    <span class=\"kw1\">return</span> <span class=\"kw3\">true</span><span class=\"sy0\">;</span><br/>  <span class=\"br0\">}</span><br/><span class=\"br0\">}</span></pre>"}, {"lang": "Perl", "loc": 30, "block": "<pre class=\"perl highlighted_source\"><span class=\"kw2\">use</span> DBI<span class=\"sy0\">;</span><br/>\u00a0<br/> <span class=\"co1\"># returns a database handle configured to throw an exception on query errors</span><br/><span class=\"kw2\">sub</span> connect_db <span class=\"br0\">{</span><br/>    <span class=\"kw1\">my</span> <span class=\"br0\">(</span><span class=\"re0\">$dbname</span><span class=\"sy0\">,</span> <span class=\"re0\">$host</span><span class=\"sy0\">,</span> <span class=\"re0\">$user</span><span class=\"sy0\">,</span> <span class=\"re0\">$pass</span><span class=\"br0\">)</span> <span class=\"sy0\">=</span> <span class=\"co5\">@_</span><span class=\"sy0\">;</span><br/>    <span class=\"kw1\">my</span> <span class=\"re0\">$db</span> <span class=\"sy0\">=</span> DBI<span class=\"sy0\">-&gt;</span><a href=\"http://perldoc.perl.org/functions/connect.html\"><span class=\"kw3\">connect</span></a><span class=\"br0\">(</span><span class=\"st0\">\"dbi:mysql:$dbname:$host\"</span><span class=\"sy0\">,</span> <span class=\"re0\">$user</span><span class=\"sy0\">,</span> <span class=\"re0\">$pass</span><span class=\"br0\">)</span><br/>        <span class=\"kw1\">or</span> <a href=\"http://perldoc.perl.org/functions/die.html\"><span class=\"kw3\">die</span></a> <span class=\"re0\">$DBI</span><span class=\"sy0\">::</span><span class=\"me2\">errstr</span><span class=\"sy0\">;</span><br/>    <span class=\"re0\">$db</span><span class=\"sy0\">-&gt;</span><span class=\"br0\">{</span>RaiseError<span class=\"br0\">}</span> <span class=\"sy0\">=</span> <span class=\"nu0\">1</span><span class=\"sy0\">;</span><br/>    <span class=\"re0\">$db</span><br/><span class=\"br0\">}</span><br/>\u00a0<br/> <span class=\"co1\"># if the user was successfully created, returns its user id.</span><br/> <span class=\"co1\"># if the name was already in use, returns undef.</span><br/><span class=\"kw2\">sub</span> create_user <span class=\"br0\">{</span><br/>    <span class=\"kw1\">my</span> <span class=\"br0\">(</span><span class=\"re0\">$db</span><span class=\"sy0\">,</span> <span class=\"re0\">$user</span><span class=\"sy0\">,</span> <span class=\"re0\">$pass</span><span class=\"br0\">)</span> <span class=\"sy0\">=</span> <span class=\"co5\">@_</span><span class=\"sy0\">;</span><br/>    <span class=\"kw1\">my</span> <span class=\"re0\">$salt</span> <span class=\"sy0\">=</span> <a href=\"http://perldoc.perl.org/functions/pack.html\"><span class=\"kw3\">pack</span></a> <span class=\"st0\">\"C*\"</span><span class=\"sy0\">,</span> <a href=\"http://perldoc.perl.org/functions/map.html\"><span class=\"kw3\">map</span></a> <span class=\"br0\">{</span><a href=\"http://perldoc.perl.org/functions/int.html\"><span class=\"kw3\">int</span></a> <a href=\"http://perldoc.perl.org/functions/rand.html\"><span class=\"kw3\">rand</span></a> <span class=\"nu0\">256</span><span class=\"br0\">}</span> <span class=\"nu0\">1</span><span class=\"sy0\">..</span><span class=\"nu0\">16</span><span class=\"sy0\">;</span><br/>    <span class=\"re0\">$db</span><span class=\"sy0\">-&gt;</span><span class=\"kw1\">do</span><span class=\"br0\">(</span><span class=\"st0\">\"INSERT IGNORE INTO users (username, pass_salt, pass_md5)<br/>        VALUES (?,\u00a0?, unhex(md5(concat(pass_salt,\u00a0?))))\"</span><span class=\"sy0\">,</span><br/>        <a href=\"http://perldoc.perl.org/functions/undef.html\"><span class=\"kw3\">undef</span></a><span class=\"sy0\">,</span> <span class=\"re0\">$user</span><span class=\"sy0\">,</span> <span class=\"re0\">$salt</span><span class=\"sy0\">,</span> <span class=\"re0\">$pass</span><span class=\"br0\">)</span><br/>      <span class=\"kw1\">and</span> <span class=\"re0\">$db</span><span class=\"sy0\">-&gt;</span><span class=\"br0\">{</span>mysql_insertid<span class=\"br0\">}</span> <span class=\"kw1\">or</span> <a href=\"http://perldoc.perl.org/functions/undef.html\"><span class=\"kw3\">undef</span></a><br/><span class=\"br0\">}</span><br/>\u00a0<br/> <span class=\"co1\"># if the user is authentic, returns its user id.  otherwise returns undef.</span><br/><span class=\"kw2\">sub</span> authenticate_user <span class=\"br0\">{</span><br/>    <span class=\"kw1\">my</span> <span class=\"br0\">(</span><span class=\"re0\">$db</span><span class=\"sy0\">,</span> <span class=\"re0\">$user</span><span class=\"sy0\">,</span> <span class=\"re0\">$pass</span><span class=\"br0\">)</span> <span class=\"sy0\">=</span> <span class=\"co5\">@_</span><span class=\"sy0\">;</span><br/>    <span class=\"kw1\">my</span> <span class=\"re0\">$userid</span> <span class=\"sy0\">=</span> <span class=\"re0\">$db</span><span class=\"sy0\">-&gt;</span><span class=\"me1\">selectrow_array</span><span class=\"br0\">(</span><span class=\"st0\">\"SELECT userid FROM users WHERE<br/>        username=? AND pass_md5=unhex(md5(concat(pass_salt,\u00a0?)))\"</span><span class=\"sy0\">,</span><br/>        <a href=\"http://perldoc.perl.org/functions/undef.html\"><span class=\"kw3\">undef</span></a><span class=\"sy0\">,</span> <span class=\"re0\">$user</span><span class=\"sy0\">,</span> <span class=\"re0\">$pass</span><span class=\"br0\">)</span><span class=\"sy0\">;</span><br/>    <span class=\"re0\">$userid</span><br/><span class=\"br0\">}</span></pre>"}, {"lang": "PHP", "loc": 71, "block": "<pre class=\"php highlighted_source\">\u00a0<br/><span class=\"kw2\">function</span> connect_db<span class=\"br0\">(</span><span class=\"re0\">$database</span><span class=\"sy0\">,</span> <span class=\"re0\">$db_user</span><span class=\"sy0\">,</span> <span class=\"re0\">$db_password</span><span class=\"sy0\">,</span> <span class=\"re0\">$host</span> <span class=\"sy0\">=</span> <span class=\"st_h\">'localhost'</span><span class=\"sy0\">,</span> <span class=\"re0\">$port</span> <span class=\"sy0\">=</span> <span class=\"kw4\">NULL</span><span class=\"sy0\">,</span> <span class=\"re0\">$die</span> <span class=\"sy0\">=</span> <span class=\"kw4\">false</span><span class=\"br0\">)</span> <span class=\"br0\">{</span><br/>\t<span class=\"co1\">// Returns a MySQL link identifier (handle) on success</span><br/>\t<span class=\"co1\">// Returns false or dies() on error depending on the setting of parameter $die</span><br/>\t<span class=\"co1\">// Parameter $die configures error handling, setting it any non-false value will die() on error</span><br/>\t<span class=\"co1\">// Parameters $host, $port and $die have sensible defaults and are not usually required</span><br/>\u00a0<br/>\t<span class=\"kw1\">if</span><span class=\"br0\">(</span><span class=\"sy0\">!</span><span class=\"re0\">$db_handle</span> <span class=\"sy0\">=</span> <span class=\"sy0\">@</span><a href=\"http://www.php.net/mysql_connect\"><span class=\"kw3\">mysql_connect</span></a><span class=\"br0\">(</span><span class=\"re0\">$host</span><span class=\"sy0\">.</span><span class=\"br0\">(</span><span class=\"re0\">$port</span>\u00a0? <span class=\"st_h\">':'</span><span class=\"sy0\">.</span><span class=\"re0\">$port</span> <span class=\"sy0\">:</span> <span class=\"st_h\">''</span><span class=\"br0\">)</span><span class=\"sy0\">,</span> <span class=\"re0\">$db_user</span><span class=\"sy0\">,</span> <span class=\"re0\">$db_password</span><span class=\"br0\">)</span><span class=\"br0\">)</span> <span class=\"br0\">{</span><br/>\t\t<span class=\"kw1\">if</span><span class=\"br0\">(</span><span class=\"re0\">$die</span><span class=\"br0\">)</span><br/>\t\t\t<a href=\"http://www.php.net/die\"><span class=\"kw3\">die</span></a><span class=\"br0\">(</span><span class=\"st0\">\"Can't connect to MySQL server:<span class=\"es1\">\\r</span><span class=\"es1\">\\n</span>\"</span><span class=\"sy0\">.</span><a href=\"http://www.php.net/mysql_error\"><span class=\"kw3\">mysql_error</span></a><span class=\"br0\">(</span><span class=\"br0\">)</span><span class=\"br0\">)</span><span class=\"sy0\">;</span><br/>\t\t<span class=\"kw1\">else</span><br/>\t\t\t<span class=\"kw1\">return</span> <span class=\"kw4\">false</span><span class=\"sy0\">;</span><br/>\t<span class=\"br0\">}</span><br/>\t<span class=\"kw1\">if</span><span class=\"br0\">(</span><span class=\"sy0\"><a class=\"__cf_email__\" data-cfemail=\"250465\" href=\"/cdn-cgi/l/email-protection\">[email\u00a0protected]</a></span><a href=\"http://www.php.net/mysql_select_db\"><span class=\"kw3\">mysql_select_db</span></a><span class=\"br0\">(</span><span class=\"re0\">$database</span><span class=\"sy0\">,</span> <span class=\"re0\">$db_handle</span><span class=\"br0\">)</span><span class=\"br0\">)</span> <span class=\"br0\">{</span><br/>\t\t<span class=\"kw1\">if</span><span class=\"br0\">(</span><span class=\"re0\">$die</span><span class=\"br0\">)</span><br/>\t\t\t<a href=\"http://www.php.net/die\"><span class=\"kw3\">die</span></a><span class=\"br0\">(</span><span class=\"st0\">\"Can't select database '<span class=\"es4\">$database</span>':<span class=\"es1\">\\r</span><span class=\"es1\">\\n</span>\"</span><span class=\"sy0\">.</span><a href=\"http://www.php.net/mysql_error\"><span class=\"kw3\">mysql_error</span></a><span class=\"br0\">(</span><span class=\"br0\">)</span><span class=\"br0\">)</span><span class=\"sy0\">;</span><br/>\t\t<span class=\"kw1\">else</span><br/>\t\t\t<span class=\"kw1\">return</span> <span class=\"kw4\">false</span><span class=\"sy0\">;</span><br/>\t<span class=\"br0\">}</span><br/>\t<span class=\"kw1\">return</span> <span class=\"re0\">$db_handle</span><span class=\"sy0\">;</span><br/><span class=\"br0\">}</span><br/>\u00a0<br/><span class=\"kw2\">function</span> create_user<span class=\"br0\">(</span><span class=\"re0\">$username</span><span class=\"sy0\">,</span> <span class=\"re0\">$password</span><span class=\"sy0\">,</span> <span class=\"re0\">$db_handle</span><span class=\"br0\">)</span> <span class=\"br0\">{</span><br/>\t<span class=\"co1\">// Returns the record ID on success or false on failure</span><br/>\t<span class=\"co1\">// Username limit is 32 characters (part of spec)</span><br/>\t<span class=\"kw1\">if</span><span class=\"br0\">(</span><a href=\"http://www.php.net/strlen\"><span class=\"kw3\">strlen</span></a><span class=\"br0\">(</span><span class=\"re0\">$username</span><span class=\"br0\">)</span> <span class=\"sy0\">&gt;</span> <span class=\"nu0\">32</span><span class=\"br0\">)</span><br/>\t\t<span class=\"kw1\">return</span> <span class=\"kw4\">false</span><span class=\"sy0\">;</span><br/>\u00a0<br/>\t<span class=\"co1\">// Salt limited to ASCII 32 thru 254 (not part of spec)</span><br/>\t<span class=\"re0\">$salt</span> <span class=\"sy0\">=</span> <span class=\"st_h\">''</span><span class=\"sy0\">;</span><br/>\t<span class=\"kw1\">do</span> <span class=\"br0\">{</span><br/>\t\t<span class=\"re0\">$salt</span> <span class=\"sy0\">.=</span> <a href=\"http://www.php.net/chr\"><span class=\"kw3\">chr</span></a><span class=\"br0\">(</span><a href=\"http://www.php.net/mt_rand\"><span class=\"kw3\">mt_rand</span></a><span class=\"br0\">(</span><span class=\"nu0\">32</span><span class=\"sy0\">,</span> <span class=\"nu0\">254</span><span class=\"br0\">)</span><span class=\"br0\">)</span><span class=\"sy0\">;</span><br/>\t<span class=\"br0\">}</span> <span class=\"kw1\">while</span><span class=\"br0\">(</span><a href=\"http://www.php.net/strlen\"><span class=\"kw3\">strlen</span></a><span class=\"br0\">(</span><span class=\"re0\">$salt</span><span class=\"br0\">)</span> <span class=\"sy0\">&lt;</span> <span class=\"nu0\">16</span><span class=\"br0\">)</span><span class=\"sy0\">;</span><br/>\u00a0<br/>\t<span class=\"co1\">// Create pass_md5</span><br/>\t<span class=\"re0\">$pass_md5</span> <span class=\"sy0\">=</span> <a href=\"http://www.php.net/md5\"><span class=\"kw3\">md5</span></a><span class=\"br0\">(</span><span class=\"re0\">$salt</span><span class=\"sy0\">.</span><span class=\"re0\">$password</span><span class=\"br0\">)</span><span class=\"sy0\">;</span><br/>\u00a0<br/>\t<span class=\"co1\">// Make it all binary safe</span><br/>\t<span class=\"re0\">$username</span> <span class=\"sy0\">=</span> <a href=\"http://www.php.net/mysql_real_escape_string\"><span class=\"kw3\">mysql_real_escape_string</span></a><span class=\"br0\">(</span><span class=\"re0\">$username</span><span class=\"br0\">)</span><span class=\"sy0\">;</span><br/>\t<span class=\"re0\">$salt</span> <span class=\"sy0\">=</span> <a href=\"http://www.php.net/mysql_real_escape_string\"><span class=\"kw3\">mysql_real_escape_string</span></a><span class=\"br0\">(</span><span class=\"re0\">$salt</span><span class=\"br0\">)</span><span class=\"sy0\">;</span><br/>\u00a0<br/>\t<span class=\"co1\">// Try to insert it into the table - Return false on failure</span><br/>\t<span class=\"kw1\">if</span><span class=\"br0\">(</span><span class=\"sy0\"><a class=\"__cf_email__\" data-cfemail=\"5c7d1c\" href=\"/cdn-cgi/l/email-protection\">[email\u00a0protected]</a></span><a href=\"http://www.php.net/mysql_query\"><span class=\"kw3\">mysql_query</span></a><span class=\"br0\">(</span><span class=\"st0\">\"INSERT INTO users (username,pass_salt,pass_md5) VALUES('<span class=\"es4\">$username</span>','<span class=\"es4\">$salt</span>','<span class=\"es4\">$pass_md5</span>')\"</span><span class=\"sy0\">,</span> <span class=\"re0\">$db_handle</span><span class=\"br0\">)</span><span class=\"br0\">)</span><br/>\t\t<span class=\"kw1\">return</span> <span class=\"kw4\">false</span><span class=\"sy0\">;</span><br/>\u00a0<br/>\t<span class=\"co1\">// Return the record ID</span><br/>\t<span class=\"kw1\">return</span> <a href=\"http://www.php.net/mysql_insert_id\"><span class=\"kw3\">mysql_insert_id</span></a><span class=\"br0\">(</span><span class=\"re0\">$db_handle</span><span class=\"br0\">)</span><span class=\"sy0\">;</span><br/><span class=\"br0\">}</span><br/>\u00a0<br/><span class=\"kw2\">function</span> authenticate_user<span class=\"br0\">(</span><span class=\"re0\">$username</span><span class=\"sy0\">,</span> <span class=\"re0\">$password</span><span class=\"sy0\">,</span> <span class=\"re0\">$db_handle</span><span class=\"br0\">)</span> <span class=\"br0\">{</span><br/>\t<span class=\"co1\">// Checks a username/password combination against the database</span><br/>\t<span class=\"co1\">// Returns false on failure or the record ID on success</span><br/>\u00a0<br/>\t<span class=\"co1\">// Make the username parmeter binary-safe</span><br/>\t<span class=\"re0\">$safe_username</span> <span class=\"sy0\">=</span> <a href=\"http://www.php.net/mysql_real_escape_string\"><span class=\"kw3\">mysql_real_escape_string</span></a><span class=\"br0\">(</span><span class=\"re0\">$username</span><span class=\"br0\">)</span><span class=\"sy0\">;</span><br/>\u00a0<br/>\t<span class=\"co1\">// Grab the record (if it exists) - Return false on failure</span><br/>\t<span class=\"kw1\">if</span><span class=\"br0\">(</span><span class=\"sy0\">!</span><span class=\"re0\">$result</span> <span class=\"sy0\">=</span> <span class=\"sy0\">@</span><a href=\"http://www.php.net/mysql_query\"><span class=\"kw3\">mysql_query</span></a><span class=\"br0\">(</span><span class=\"st0\">\"SELECT * FROM users WHERE username='<span class=\"es4\">$safe_username</span>'\"</span><span class=\"sy0\">,</span> <span class=\"re0\">$db_handle</span><span class=\"br0\">)</span><span class=\"br0\">)</span><br/>\t\t<span class=\"kw1\">return</span> <span class=\"kw4\">false</span><span class=\"sy0\">;</span><br/>\u00a0<br/>\t<span class=\"co1\">// Grab the row</span><br/>\t<span class=\"re0\">$row</span> <span class=\"sy0\">=</span> <span class=\"sy0\">@</span><a href=\"http://www.php.net/mysql_fetch_assoc\"><span class=\"kw3\">mysql_fetch_assoc</span></a><span class=\"br0\">(</span><span class=\"re0\">$result</span><span class=\"br0\">)</span><span class=\"sy0\">;</span><br/>\u00a0<br/>\t<span class=\"co1\">// Check the password and return false if incorrect</span><br/>\t<span class=\"kw1\">if</span><span class=\"br0\">(</span><a href=\"http://www.php.net/md5\"><span class=\"kw3\">md5</span></a><span class=\"br0\">(</span><span class=\"re0\">$row</span><span class=\"br0\">[</span><span class=\"st_h\">'pass_salt'</span><span class=\"br0\">]</span><span class=\"sy0\">.</span><span class=\"re0\">$password</span><span class=\"br0\">)</span> <span class=\"sy0\">!=</span> <span class=\"re0\">$row</span><span class=\"br0\">[</span><span class=\"st_h\">'pass_md5'</span><span class=\"br0\">]</span><span class=\"br0\">)</span><br/>\t\t<span class=\"kw1\">return</span> <span class=\"kw4\">false</span><span class=\"sy0\">;</span><br/>\u00a0<br/>\t<span class=\"co1\">// Return the record ID</span><br/>\t<span class=\"kw1\">return</span> <span class=\"re0\">$row</span><span class=\"br0\">[</span><span class=\"st_h\">'userid'</span><span class=\"br0\">]</span><span class=\"sy0\">;</span><br/><span class=\"br0\">}</span><br/>\u00a0</pre>"}, {"lang": "Python", "loc": 83, "block": "<pre class=\"python highlighted_source\"><span class=\"kw1\">import</span> mysql.<span class=\"me1\">connector</span> <br/><span class=\"kw1\">import</span> hashlib<br/>\u00a0<br/><span class=\"kw1\">import</span> <span class=\"kw3\">sys</span>\t <br/><span class=\"kw1\">import</span> <span class=\"kw3\">random</span>\t <br/>\u00a0<br/>DB_HOST <span class=\"sy0\">=</span> <span class=\"st0\">\"localhost\"</span>\t <br/>DB_USER <span class=\"sy0\">=</span> <span class=\"st0\">\"devel\"</span> <br/>DB_PASS <span class=\"sy0\">=</span> <span class=\"st0\">\"devel\"</span>\t <br/>DB_NAME <span class=\"sy0\">=</span> <span class=\"st0\">\"test\"</span>\t <br/>\u00a0<br/><span class=\"kw1\">def</span> connect_db<span class=\"br0\">(</span><span class=\"br0\">)</span>:\t <br/>    <span class=\"st0\">''' Try to connect DB and return DB instance, if not, return False '''</span>\t <br/>    <span class=\"kw1\">try</span>:\t <br/>        <span class=\"kw1\">return</span> mysql.<span class=\"me1\">connector</span>.<span class=\"me1\">connect</span><span class=\"br0\">(</span>host<span class=\"sy0\">=</span>DB_HOST<span class=\"sy0\">,</span> <span class=\"kw3\">user</span><span class=\"sy0\">=</span>DB_USER<span class=\"sy0\">,</span> passwd<span class=\"sy0\">=</span>DB_PASS<span class=\"sy0\">,</span> db<span class=\"sy0\">=</span>DB_NAME<span class=\"br0\">)</span>\t <br/>    <span class=\"kw1\">except</span>:\t <br/>        <span class=\"kw1\">return</span> <span class=\"kw2\">False</span>\t <br/>\u00a0<br/><span class=\"kw1\">def</span> create_user<span class=\"br0\">(</span>username<span class=\"sy0\">,</span> passwd<span class=\"br0\">)</span>:\t <br/>    <span class=\"st0\">''' if user was successfully created, returns its ID; returns None on error '''</span>\t <br/>    db <span class=\"sy0\">=</span> connect_db<span class=\"br0\">(</span><span class=\"br0\">)</span>\t <br/>    <span class=\"kw1\">if</span> <span class=\"kw1\">not</span> db:\t <br/>        <span class=\"kw1\">print</span> <span class=\"st0\">\"Can't connect MySQL!\"</span><br/>        <span class=\"kw1\">return</span> <span class=\"kw2\">None</span><br/>\u00a0<br/>    cursor <span class=\"sy0\">=</span> db.<span class=\"me1\">cursor</span><span class=\"br0\">(</span><span class=\"br0\">)</span>\t <br/>\u00a0<br/>    salt <span class=\"sy0\">=</span> randomValue<span class=\"br0\">(</span><span class=\"nu0\">16</span><span class=\"br0\">)</span>\t \t <br/>    passwd_md5 <span class=\"sy0\">=</span> hashlib.<span class=\"kw3\">md5</span><span class=\"br0\">(</span>salt+passwd<span class=\"br0\">)</span>.<span class=\"me1\">hexdigest</span><span class=\"br0\">(</span><span class=\"br0\">)</span>\t <br/>\u00a0<br/>    <span class=\"co1\"># If username already taken, inform it\t </span><br/>    <span class=\"kw1\">try</span>:\t <br/>        cursor.<span class=\"me1\">execute</span><span class=\"br0\">(</span><span class=\"st0\">\"INSERT INTO users (`username`, `pass_salt`, `pass_md5`) VALUES (%s,\u00a0%s,\u00a0%s)\"</span><span class=\"sy0\">,</span> <span class=\"br0\">(</span>username<span class=\"sy0\">,</span> salt<span class=\"sy0\">,</span> passwd_md5<span class=\"br0\">)</span><span class=\"br0\">)</span> <br/>        cursor.<span class=\"me1\">execute</span><span class=\"br0\">(</span><span class=\"st0\">\"SELECT userid FROM users WHERE username=%s\"</span><span class=\"sy0\">,</span> <span class=\"br0\">(</span>username<span class=\"sy0\">,</span><span class=\"br0\">)</span> <span class=\"br0\">)</span> <br/>        <span class=\"kw2\">id</span> <span class=\"sy0\">=</span> cursor.<span class=\"me1\">fetchone</span><span class=\"br0\">(</span><span class=\"br0\">)</span><br/>        db.<span class=\"me1\">commit</span><span class=\"br0\">(</span><span class=\"br0\">)</span><br/>        cursor.<span class=\"me1\">close</span><span class=\"br0\">(</span><span class=\"br0\">)</span><br/>        db.<span class=\"me1\">close</span><span class=\"br0\">(</span><span class=\"br0\">)</span><br/>        <span class=\"kw1\">return</span> <span class=\"kw2\">id</span><span class=\"br0\">[</span><span class=\"nu0\">0</span><span class=\"br0\">]</span>\t <br/>    <span class=\"kw1\">except</span>:\t <br/>        <span class=\"kw1\">print</span> <span class=\"st0\">'Username was already taken. Please select another'</span>\t <br/>        <span class=\"kw1\">return</span> <span class=\"kw2\">None</span><br/>\u00a0<br/><span class=\"kw1\">def</span> authenticate_user<span class=\"br0\">(</span>username<span class=\"sy0\">,</span> passwd<span class=\"br0\">)</span>:\t <br/>    db <span class=\"sy0\">=</span> connect_db<span class=\"br0\">(</span><span class=\"br0\">)</span>\t <br/>    <span class=\"kw1\">if</span> <span class=\"kw1\">not</span> db:\t <br/>        <span class=\"kw1\">print</span> <span class=\"st0\">\"Can't connect MySQL!\"</span><br/>        <span class=\"kw1\">return</span> <span class=\"kw2\">False</span><br/>\u00a0<br/>    cursor <span class=\"sy0\">=</span> db.<span class=\"me1\">cursor</span><span class=\"br0\">(</span><span class=\"br0\">)</span>\t <br/>\u00a0<br/>    cursor.<span class=\"me1\">execute</span><span class=\"br0\">(</span><span class=\"st0\">\"SELECT pass_salt, pass_md5 FROM users WHERE username=%s\"</span><span class=\"sy0\">,</span> <span class=\"br0\">(</span>username<span class=\"sy0\">,</span><span class=\"br0\">)</span><span class=\"br0\">)</span><br/>\u00a0<br/>    row <span class=\"sy0\">=</span> cursor.<span class=\"me1\">fetchone</span><span class=\"br0\">(</span><span class=\"br0\">)</span><br/>    cursor.<span class=\"me1\">close</span><span class=\"br0\">(</span><span class=\"br0\">)</span><br/>    db.<span class=\"me1\">close</span><span class=\"br0\">(</span><span class=\"br0\">)</span><br/>    <span class=\"kw1\">if</span> row <span class=\"kw1\">is</span> <span class=\"kw2\">None</span>:     <span class=\"co1\"># username not found</span><br/>        <span class=\"kw1\">return</span> <span class=\"kw2\">False</span><br/>    salt <span class=\"sy0\">=</span> row<span class=\"br0\">[</span><span class=\"nu0\">0</span><span class=\"br0\">]</span><br/>    correct_md5 <span class=\"sy0\">=</span> row<span class=\"br0\">[</span><span class=\"nu0\">1</span><span class=\"br0\">]</span><br/>    tried_md5 <span class=\"sy0\">=</span> hashlib.<span class=\"kw3\">md5</span><span class=\"br0\">(</span>salt+passwd<span class=\"br0\">)</span>.<span class=\"me1\">hexdigest</span><span class=\"br0\">(</span><span class=\"br0\">)</span><br/>    <span class=\"kw1\">return</span> correct_md5 <span class=\"sy0\">==</span> tried_md5<br/>\u00a0<br/><span class=\"kw1\">def</span> randomValue<span class=\"br0\">(</span>length<span class=\"br0\">)</span>:\t <br/>    <span class=\"st0\">''' Creates random value with given length'''</span>\t <br/>    salt_chars <span class=\"sy0\">=</span> <span class=\"st0\">'abcdefghijklmnopqrstuvwxyz0123456789'</span><br/>\u00a0<br/>    <span class=\"kw1\">return</span> <span class=\"st0\">''</span>.<span class=\"me1\">join</span><span class=\"br0\">(</span><span class=\"kw3\">random</span>.<span class=\"me1\">choice</span><span class=\"br0\">(</span>salt_chars<span class=\"br0\">)</span> <span class=\"kw1\">for</span> x <span class=\"kw1\">in</span> <span class=\"kw2\">range</span><span class=\"br0\">(</span>length<span class=\"br0\">)</span><span class=\"br0\">)</span><br/>\u00a0<br/><span class=\"kw1\">if</span> __name__ <span class=\"sy0\">==</span> <span class=\"st0\">'__main__'</span>:\t <br/>    <span class=\"kw3\">user</span> <span class=\"sy0\">=</span> randomValue<span class=\"br0\">(</span><span class=\"nu0\">10</span><span class=\"br0\">)</span><br/>    passwd <span class=\"sy0\">=</span> randomValue<span class=\"br0\">(</span><span class=\"nu0\">16</span><span class=\"br0\">)</span>\t <br/>\u00a0<br/>    new_user_id <span class=\"sy0\">=</span> create_user<span class=\"br0\">(</span><span class=\"kw3\">user</span><span class=\"sy0\">,</span> passwd<span class=\"br0\">)</span><br/>    <span class=\"kw1\">if</span> new_user_id <span class=\"kw1\">is</span> <span class=\"kw2\">None</span>:<br/>        <span class=\"kw1\">print</span> <span class=\"st0\">'Failed to create user\u00a0%s'</span>\u00a0% <span class=\"kw3\">user</span><br/>        <span class=\"kw3\">sys</span>.<span class=\"me1\">exit</span><span class=\"br0\">(</span><span class=\"nu0\">1</span><span class=\"br0\">)</span><br/>    auth <span class=\"sy0\">=</span> authenticate_user<span class=\"br0\">(</span><span class=\"kw3\">user</span><span class=\"sy0\">,</span> passwd<span class=\"br0\">)</span>\t <br/>    <span class=\"kw1\">if</span> auth:\t <br/>        <span class=\"kw1\">print</span> <span class=\"st0\">'User\u00a0%s authenticated successfully'</span>\u00a0% <span class=\"kw3\">user</span>\t <br/>    <span class=\"kw1\">else</span>:\t <br/>        <span class=\"kw1\">print</span> <span class=\"st0\">'User\u00a0%s failed'</span>\u00a0% <span class=\"kw3\">user</span><br/>\u00a0</pre>"}, {"lang": "Racket", "loc": 65, "block": "<pre class=\"text highlighted_source\">#lang racket<br/>(require db file/md5)<br/>(define-logger authentication)<br/>(current-logger authentication-logger)<br/>\u00a0<br/>(define DB-HOST \"localhost\")<br/>(define DB-USER \"devel\")<br/>(define DB-PASS \"devel\")\t <br/>(define DB-NAME \"test\")\t <br/>\u00a0<br/>(define (connect-db)<br/>  (mysql-connect<br/>   #:user DB-USER<br/>   #:database DB-NAME<br/>   #:password DB-PASS))<br/>\u00a0<br/>(define (salt+password-&gt;hash salt password #:hex-encode? (hex-encode? #f))<br/>  (md5 (bytes-append salt password) hex-encode?))<br/>\u00a0<br/>(define (report-sql-error e)<br/>  (log-authentication-error \"Failed to create user:~s\" (exn-message e))<br/>  #f)<br/>\u00a0<br/>(define (create-user db username passwd)<br/> \u00a0; if user was successfully created, returns its ID else #f<br/>  (define salt (list-&gt;bytes (for/list ((i (in-range 16))) (random 256))))<br/>  (define hash (salt+password-&gt;hash salt passwd))  <br/>  (with-handlers ((exn:fail:sql? report-sql-error))<br/>    (query db \"INSERT INTO users (username, pass_salt, pass_md5) VALUES (?,\u00a0?,\u00a0?)\"<br/>           username salt hash)))<br/>\u00a0<br/>(define (authenticate-user db username password)<br/>  (or<br/>   (match (query-maybe-row db \"SELECT pass_salt, pass_md5 FROM users WHERE username =\u00a0?\" username)<br/>     [#f #f]<br/>     [(vector salt hash) (bytes=? hash (salt+password-&gt;hash salt password))])<br/>  \u00a0; don't let the deviants know whether it's the username or password that's dodgy<br/>   (error \"the username, password combination does not exist in system\")))<br/>\u00a0<br/>(module+ test<br/>  (require rackunit)<br/>  (define test-DB (connect-db))  <br/> \u00a0; typically, you only do this the once (or risk upsetting your users bigtime!)<br/> \u00a0; call this just the once!<br/>  (define (create-users-table db)  <br/>    (query-exec db \"DROP TABLE IF EXISTS users\")  <br/>    (query-exec db #&lt;&lt;EOS<br/>CREATE TABLE users (<br/>    userid INT PRIMARY KEY AUTO_INCREMENT,<br/>    username VARCHAR(32) UNIQUE KEY NOT NULL,<br/>    pass_salt tinyblob NOT NULL,<br/>            -- a string of 16 random bytes<br/>    pass_md5 tinyblob NOT NULL<br/>            -- binary MD5 hash of pass_salt concatenated with the password<br/>);<br/>EOS<br/>                ))  <br/>  (create-users-table test-DB)    <br/>  (create-user test-DB #\"tim\" #\"shh! it's a secret!\")  <br/> \u00a0; ensure the user exists (for testing purposes)<br/>  (check-match (query-list test-DB \"SELECT userid FROM users WHERE username = 'tim'\") (list _))<br/> \u00a0; (ah... but tim exists!!!)<br/>  (check-false (create-user test-DB #\"tim\" #\"tim's password\"))  <br/>  (check-exn exn:fail? (\u03bb () (authenticate-user test-DB #\"tim\" #\"password\")))<br/>  (check-true (authenticate-user test-DB #\"tim\" #\"shh! it's a secret!\")))</pre>"}, {"lang": "Raven", "loc": 31, "block": "<pre class=\"text highlighted_source\"> 'mysql://<a class=\"__cf_email__\" data-cfemail=\"beccd1d1cafed2d1dddfd2d6d1cdca\" href=\"/cdn-cgi/l/email-protection\">[email\u00a0protected]</a>/test' open as mysql<br/>'abcdefghijklmnopqrstuvwxyz0123456789' as $salt_chars<br/>\u00a0<br/># return userid for success and FALSE for failure.<br/>define create_user use $user, $pass<br/>    group 16 each as i<br/>        $salt_chars choose chr<br/>    join as $pass_salt<br/>     \"%($pass_salt)s%($pass)s\" md5 as $pass_md5<br/>    $user copy mysql escape as $user_name<br/>    group 'INSERT IGNORE into users (username, pass_md5, pass_salt)'<br/>        \" VALUES ('%($user_name)s', unhex('%($pass_md5)s'), '%($pass_salt)s')\"<br/>    join mysql query inserted<br/>\u00a0<br/># return userid for success and FALSE for failure.<br/>define authenticate_user use $user, $pass<br/>    FALSE as $userid<br/>    $user copy mysql escape as $user_name<br/>    group 'SELECT userid, pass_salt, hex(pass_md5)'<br/>        \" FROM users WHERE username = '%($user_name)s'\"<br/>    join mysql query as rs<br/>    rs selected<br/>    if  rs fetch values into $possible_userid, $pass_salt, $pass_md5<br/>        \"%($pass_salt)s%($pass)s\" md5 $pass_md5 lower =<br/>        if  $possible_userid as $userid<br/>    $userid<br/>\u00a0<br/>'foo' 'bar' create_user      \u00a0!if \"could not create user\\n\"       print bye<br/>'foo' 'bar' authenticate_user\u00a0!if \"could not authenticate user\\n\" print bye<br/>\u00a0<br/>\"user successfully created and authenticated!\\n\" print</pre>"}, {"lang": "Sidef", "loc": 27, "block": "<pre class=\"ruby highlighted_source\"><span class=\"kw3\">require</span><span class=\"br0\">(</span><span class=\"st0\">'DBI'</span><span class=\"br0\">)</span><br/>\u00a0<br/> <span class=\"co1\"># returns a database handle configured to throw an exception on query errors</span><br/>func connect_db<span class=\"br0\">(</span>dbname, host, user, pass<span class=\"br0\">)</span> <span class=\"br0\">{</span><br/>    var db = <span class=\"sy0\">%</span>s<span class=\"sy0\">&lt;</span>DBI<span class=\"sy0\">&gt;</span>.<span class=\"me1\">connect</span><span class=\"br0\">(</span><span class=\"st0\">\"dbi:mysql:#{dbname}:#{host}\"</span>, user, pass<span class=\"br0\">)</span><br/>    db <span class=\"sy0\">||</span> die <span class=\"br0\">(</span>global DBI::errstr<span class=\"br0\">)</span><br/>    db<span class=\"br0\">{</span>:RaiseError<span class=\"br0\">}</span> = <span class=\"nu0\">1</span><br/>    db<br/><span class=\"br0\">}</span><br/>\u00a0<br/> <span class=\"co1\"># if the user was successfully created, returns its user id.</span><br/> <span class=\"co1\"># if the name was already in use, returns nil.</span><br/>func create_user<span class=\"br0\">(</span>db, user, pass<span class=\"br0\">)</span> <span class=\"br0\">{</span><br/>    var salt = <span class=\"st0\">\"C*\"</span>.<span class=\"me1\">pack</span><span class=\"br0\">(</span><span class=\"nu0\">16</span>.<span class=\"me1\">of</span> <span class=\"br0\">{</span> <span class=\"nu0\">256</span>.<span class=\"me1\">irand</span> <span class=\"br0\">}</span>...<span class=\"br0\">)</span><br/>    db.<span class=\"kw1\">do</span><span class=\"br0\">(</span><br/>        <span class=\"st0\">\"INSERT IGNORE INTO users (username, pass_salt, pass_md5)<br/>         VALUES (?,\u00a0?, unhex(md5(concat(pass_salt,\u00a0?))))\"</span>, <span class=\"kw2\">nil</span>, user, salt, pass<br/>    <span class=\"br0\">)</span>\u00a0? db<span class=\"br0\">{</span>:mysql_insertid<span class=\"br0\">}</span>\u00a0: <span class=\"kw2\">nil</span><br/><span class=\"br0\">}</span><br/>\u00a0<br/> <span class=\"co1\"># if the user is authentic, returns its user id.  otherwise returns nil.</span><br/>func authenticate_user<span class=\"br0\">(</span>db, user, pass<span class=\"br0\">)</span> <span class=\"br0\">{</span><br/>    db.<span class=\"me1\">selectrow_array</span><span class=\"br0\">(</span><span class=\"st0\">\"SELECT userid FROM users WHERE<br/>        username=? AND pass_md5=unhex(md5(concat(pass_salt,\u00a0?)))\"</span>,<br/>        <span class=\"kw2\">nil</span>, user, pass<br/>    <span class=\"br0\">)</span><br/><span class=\"br0\">}</span></pre>"}, {"lang": "Tcl", "loc": 36, "block": "<pre class=\"tcl highlighted_source\"><span class=\"kw2\">package</span> require tdbc<br/>\u00a0<br/><span class=\"kw1\">proc</span> connect_db <span class=\"br0\">{</span>handleName dbname host user pass<span class=\"br0\">}</span> <span class=\"br0\">{</span><br/>    <span class=\"kw2\">package</span> require tdbc::<span class=\"me1\">mysql</span><br/>    tdbc::<span class=\"me1\">mysql</span>::<span class=\"me1\">connection</span> create <span class=\"re0\">$handleName</span> -user <span class=\"re0\">$user</span> -passwd <span class=\"re0\">$pass</span> \\<br/>        -host <span class=\"re0\">$host</span> -database <span class=\"re0\">$dbname</span><br/>    <span class=\"kw1\">return</span> <span class=\"re0\">$handleName</span><br/><span class=\"br0\">}</span><br/>\u00a0<br/><span class=\"co1\"># A simple helper to keep code shorter</span><br/><span class=\"kw1\">proc</span> r64k <span class=\"br0\">{</span><span class=\"br0\">}</span> <span class=\"br0\">{</span><br/>    <span class=\"kw1\">expr</span> int<span class=\"br0\">(</span><span class=\"nu0\">65536</span><span class=\"sy0\">*</span>rand<span class=\"br0\">(</span><span class=\"br0\">)</span><span class=\"br0\">)</span><br/><span class=\"br0\">}</span><br/>\u00a0<br/><span class=\"kw1\">proc</span> create_user <span class=\"br0\">{</span>handle user pass<span class=\"br0\">}</span> <span class=\"br0\">{</span><br/>    <span class=\"kw1\">set</span> salt <span class=\"br0\">[</span><span class=\"kw2\">binary</span> <span class=\"kw2\">format</span> ssssssss \\<br/>        <span class=\"br0\">[</span>r64k<span class=\"br0\">]</span> <span class=\"br0\">[</span>r64k<span class=\"br0\">]</span> <span class=\"br0\">[</span>r64k<span class=\"br0\">]</span> <span class=\"br0\">[</span>r64k<span class=\"br0\">]</span> <span class=\"br0\">[</span>r64k<span class=\"br0\">]</span> <span class=\"br0\">[</span>r64k<span class=\"br0\">]</span> <span class=\"br0\">[</span>r64k<span class=\"br0\">]</span> <span class=\"br0\">[</span>r64k<span class=\"br0\">]</span><span class=\"br0\">]</span><br/>    <span class=\"co1\"># Note that we are using named parameters below,\u00a0:user\u00a0:salt\u00a0:pass</span><br/>    <span class=\"co1\"># They are bound automatically to local variables with the same name</span><br/>    <span class=\"re0\">$handle</span> allrows <span class=\"br0\">{</span><br/>        INSERT IGNORE INTO users <span class=\"br0\">(</span>username, pass_salt, pass_md5<span class=\"br0\">)</span><br/>            VALUES <span class=\"br0\">(</span>:user,\u00a0:salt, unhex<span class=\"br0\">(</span>md5<span class=\"br0\">(</span><span class=\"kw2\">concat</span><span class=\"br0\">(</span>:salt,\u00a0:pass<span class=\"br0\">)</span><span class=\"br0\">)</span><span class=\"br0\">)</span><span class=\"br0\">)</span><br/>    <span class=\"br0\">}</span><br/>    <span class=\"kw1\">return</span>   <span class=\"sy0\">;</span><span class=\"co1\"># Ignore the result of the allrows method</span><br/><span class=\"br0\">}</span><br/>\u00a0<br/><span class=\"kw1\">proc</span> authenticate_user <span class=\"br0\">{</span>handle user pass<span class=\"br0\">}</span> <span class=\"br0\">{</span><br/>    <span class=\"re0\">$handle</span> <span class=\"kw1\">foreach</span> row <span class=\"br0\">{</span><br/>        SELECT userid FROM users WHERE<br/>            username=:user AND pass_md5=unhex<span class=\"br0\">(</span>md5<span class=\"br0\">(</span><span class=\"kw2\">concat</span><span class=\"br0\">(</span>pass_salt,\u00a0:pass<span class=\"br0\">)</span><span class=\"br0\">)</span><span class=\"br0\">)</span><br/>    <span class=\"br0\">}</span> <span class=\"br0\">{</span><br/>        <span class=\"kw1\">return</span> <span class=\"br0\">[</span>dict get <span class=\"re0\">$row</span> userid<span class=\"br0\">]</span><br/>    <span class=\"br0\">}</span><br/>    <span class=\"co1\"># Only get here if no rows selected</span><br/>    <span class=\"kw1\">error</span> <span class=\"st0\">\"authentication failed for user <span class=\"es0\">\\\"</span>$user<span class=\"es0\">\\\"</span>\"</span><br/><span class=\"br0\">}</span></pre>"}]}